#!/opt/homebrew/bin/bash
# Modern Format Boost - Drag & Drop Processor v6.5.2
# 
# ğŸ”¥ v6.5.2: ä¿®å¤"è¾“å‡ºåˆ°ç›¸é‚»ç›®å½•"æ¨¡å¼ä¸‹è·³è¿‡çš„æ–‡ä»¶æœªè¢«å¤åˆ¶çš„é—®é¢˜
#            - çŸ­åŠ¨ç”»(< 3s)è¢«è·³è¿‡æ—¶ï¼Œå¤åˆ¶åŸå§‹æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
#            - æ— æ³•å‹ç¼©çš„è§†é¢‘è¢«ä¿æŠ¤æ—¶ï¼Œå¤åˆ¶åŸå§‹æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
#            - ç¡®ä¿è¾“å‡ºç›®å½•åŒ…å«æ‰€æœ‰æ–‡ä»¶ï¼Œæ— é—æ¼
# ğŸ”¥ v6.5.1: å–æ¶ˆç¡¬ä¸Šé™æœºåˆ¶ï¼æ”¹ä¸ºä¿åº•æœºåˆ¶
#            - é•¿è§†é¢‘ä¸å†é™åˆ¶è¿­ä»£æ¬¡æ•°ï¼Œç®—æ³•é€šè¿‡ SSIM é¥±å’Œè‡ªç„¶åœæ­¢
#            - ä¿åº•ä¸Šé™åªåœ¨æç«¯å¼‚å¸¸æ—¶è§¦å‘ï¼ˆ100/80æ¬¡ï¼‰
# ğŸ”¥ v6.2: æé™æ¢ç´¢æ¨¡å¼ - --ultimate flag æŒç»­æœç´¢ç›´åˆ° SSIM å®Œå…¨é¥±å’Œ
#          åˆ é™¤ --cpu flagï¼ˆå·²æ— å®é™…ä½œç”¨ï¼‰ï¼Œå®Œå–„ flag ç»„åˆéªŒè¯
# ğŸ”¥ v6.1: è¾¹ç•Œç²¾ç»†è°ƒæ•´ - åˆ°è¾¾min_crfè¾¹ç•Œæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°0.1ç²¾ç»†é˜¶æ®µ
# ğŸ”¥ v6.0: GPUæ›²çº¿æ¨¡å‹ç­–ç•¥ - GPUé˜¶æ®µä¹Ÿä½¿ç”¨æ¿€è¿›æ’å¢™+ç²¾ç»†å›é€€
# ğŸ”¥ v5.99: CPUæ›²çº¿æ¨¡å‹ + ç²¾ç»†è°ƒæ•´é˜¶æ®µ - å½“æ›²çº¿æ­¥é•¿<1.0æ—¶åˆ‡æ¢åˆ°0.1ç²¾ç»†æœç´¢
# ğŸ”¥ v5.98: æ›²çº¿æ¨¡å‹è¶…æ¿€è¿›ç­–ç•¥ - å…¨ç¨‹æ¿€è¿›ï¼Œ4æ¬¡æ’å¢™å³åœ
# ğŸ”¥ v5.97: è¶…æ¿€è¿›CPUæ­¥è¿›ç­–ç•¥ - æ—©æœŸå¤§è·¨æ­¥ï¼Œå¿«é€Ÿæ’å¢™
# ğŸ”¥ v5.96: æ›´æ¿€è¿›çš„CPUæ­¥è¿›ç­–ç•¥ - æ›´å¿«è§¦å¢™ï¼Œå‡å°‘è¿­ä»£æ¬¡æ•°
# ğŸ”¥ v5.95: æ¿€è¿›æ’å¢™ç®—æ³• - æ‰©å¤§CPUæœç´¢èŒƒå›´(3â†’15 CRF)ï¼Œè®©ç®—æ³•çœŸæ­£æ’å¢™
# ğŸ”¥ v5.94: ä¿®å¤VMAFè´¨é‡è¯„çº§é˜ˆå€¼ + æ¸…ç†ç¼–è¯‘è­¦å‘Š
# ğŸ”¥ v5.78: é»˜è®¤æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
# - ç§»é™¤ >/dev/null 2>&1ï¼Œæ˜¾ç¤ºè½¬æ¢å·¥å…·çš„å®Œæ•´è¾“å‡º
# - ç”¨æˆ·å¯ä»¥çœ‹åˆ°CRFæœç´¢è¿‡ç¨‹ã€SSIMéªŒè¯ã€é”™è¯¯ä¿¡æ¯ç­‰
# 
# ğŸ”¥ v5.77: ä¿®å¤å­shellå¾ªç¯é—®é¢˜
# - ä½¿ç”¨æ•°ç»„æ”¶é›†æ–‡ä»¶åˆ—è¡¨ï¼Œé¿å…ç®¡é“å­shellé—®é¢˜
# - ä¿®å¤è¿›åº¦è®¡æ•°å™¨å’Œå¾ªç¯æå‰é€€å‡º
# 
# ğŸ”¥ v5.76: XMPè¾¹è½¦è‡ªåŠ¨åˆå¹¶
# - è½¬æ¢å·¥å…·å†…ç½®XMPåˆå¹¶ï¼Œæ— éœ€ç‹¬ç«‹è°ƒç”¨xmp-merge
# - æ”¯æŒ photo.jpg.xmp / photo.xmp / å¤§å°å†™ä¸æ•æ„Ÿ
# 
# ğŸ”¥ v5.70: æ™ºèƒ½ç¼–è¯‘ç³»ç»Ÿ
# - æ—¶é—´æˆ³æ¯”å¯¹ï¼šåªåœ¨æºä»£ç æ›´æ–°æ—¶é‡æ–°ç¼–è¯‘
# - ç‰ˆæœ¬å·è¯†åˆ«ï¼šæ£€æµ‹ç‰ˆæœ¬ä¸åŒ¹é…
# - ä¾èµ–ä¼ æ’­ï¼šshared_utils ä¿®æ”¹è§¦å‘å…¨éƒ¨é‡ç¼–è¯‘
# 
# ä½¿ç”¨æ–¹æ³•ï¼šå°†æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤è„šæœ¬ä¸Šï¼Œæˆ–åŒå‡»åé€‰æ‹©æ–‡ä»¶å¤¹
# é»˜è®¤å‚æ•°ï¼š--explore --match-quality --compress --apple-compat --in-place

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# å·¥å…·è·¯å¾„
IMGQUALITY_HEVC="$PROJECT_ROOT/imgquality_hevc/target/release/imgquality-hevc"
VIDQUALITY_HEVC="$PROJECT_ROOT/vidquality_hevc/target/release/vidquality-hevc"
XMP_MERGER="$PROJECT_ROOT/xmp_merger/target/release/xmp-merge"

# æ¨¡å¼è®¾ç½®
OUTPUT_MODE="inplace"
OUTPUT_DIR=""
SELECTED=0
ULTIMATE_MODE=true

# ç»ˆç«¯é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ğŸ”¥ v5.5: è¿›åº¦æ¡è¾…åŠ©å‡½æ•°
TERM_WIDTH=$(tput cols 2>/dev/null || echo 80)
PROGRESS_LINE=""

# æ¸…é™¤å½“å‰è¡Œå¹¶æ‰“å°
print_progress() {
    printf '\r\033[K%s' "$1"
}

# æ‰“å°å›ºå®šåº•éƒ¨è¿›åº¦æ¡†
print_progress_box() {
    local stage="$1"
    local current="$2"
    local total="$3"
    local file="$4"
    local extra="$5"
    
    local pct=$((current * 100 / total))
    local bar_width=30
    local filled=$((pct * bar_width / 100))
    local empty=$((bar_width - filled))
    
    local bar=""
    for ((i=0; i<filled; i++)); do bar+="â”"; done
    for ((i=0; i<empty; i++)); do bar+="â”€"; done
    
    printf '\r\033[K'
    printf "${CYAN}â”‚${NC} %s ${CYAN}â”‚${NC} [${GREEN}%s${NC}] %d/%d (%d%%) ${CYAN}â”‚${NC} %s ${CYAN}â”‚${NC}" \
        "$stage" "$bar" "$current" "$total" "$pct" "${file:0:30}"
    [[ -n "$extra" ]] && printf " %s" "$extra"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ–¹å‘é”®é€‰æ‹©èœå• (v5.2)
# ä½¿ç”¨å…¨å±€å˜é‡ SELECTED è¿”å›ç»“æœï¼Œé¿å… set -e é—®é¢˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
select_menu() {
    local opt1="$1"
    local opt2="$2"
    SELECTED=0
    
    # éšè—å…‰æ ‡
    printf '\033[?25l'
    
    # ç»˜åˆ¶å‡½æ•°
    draw() {
        if [[ $SELECTED -eq 0 ]]; then
            printf "  \033[32mâ–¶ \033[1m%s\033[0m\n" "$opt1"
            printf "    \033[2m%s\033[0m\n" "$opt2"
        else
            printf "    \033[2m%s\033[0m\n" "$opt1"
            printf "  \033[32mâ–¶ \033[1m%s\033[0m\n" "$opt2"
        fi
    }
    
    # æ¸…é™¤ä¸¤è¡Œ
    clear2() {
        printf '\033[A\033[2K\033[A\033[2K'
    }
    
    draw
    
    while true; do
        # è¯»å–ä¸€ä¸ªå­—ç¬¦
        local c
        IFS= read -rsn1 c 2>/dev/null || c=""
        
        # æ£€æŸ¥ ESC åºåˆ—
        if [[ "$c" == $'\033' ]]; then
            local c2 c3
            IFS= read -rsn1 -t 0.1 c2 2>/dev/null || c2=""
            IFS= read -rsn1 -t 0.1 c3 2>/dev/null || c3=""
            # ä¸Šç®­å¤´: ESC [ A æˆ– ESC O A
            if [[ "$c2" == "[" && "$c3" == "A" ]] || [[ "$c2" == "O" && "$c3" == "A" ]]; then
                SELECTED=$((1 - SELECTED))
                clear2; draw
            # ä¸‹ç®­å¤´: ESC [ B æˆ– ESC O B
            elif [[ "$c2" == "[" && "$c3" == "B" ]] || [[ "$c2" == "O" && "$c3" == "B" ]]; then
                SELECTED=$((1 - SELECTED))
                clear2; draw
            fi
        # Enter
        elif [[ "$c" == "" ]]; then
            break
        # j/k vim é£æ ¼
        elif [[ "$c" == "j" || "$c" == "k" ]]; then
            SELECTED=$((1 - SELECTED))
            clear2; draw
        # æ•°å­— 1/2
        elif [[ "$c" == "1" ]]; then
            SELECTED=0; clear2; draw
        elif [[ "$c" == "2" ]]; then
            SELECTED=1; clear2; draw
        # q é€€å‡º
        elif [[ "$c" == "q" || "$c" == "Q" ]]; then
            printf '\033[?25h'
            echo -e "\n${RED}âŒ ç”¨æˆ·å–æ¶ˆ${NC}"
            exit 0
        fi
    done
    
    printf '\033[?25h'
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ£€æŸ¥å·¥å…·
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
check_tools() {
    # ğŸ”¥ v5.70: æ™ºèƒ½ç¼–è¯‘ - åªåœ¨æºä»£ç æ›´æ–°æ—¶é‡æ–°ç¼–è¯‘
    "$SCRIPT_DIR/smart_build.sh" || {
        echo -e "${RED}âŒ Build failed${NC}"
        exit 1
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_welcome() {
    printf '\033[2J\033[H'
    echo ""
    echo -e "${CYAN}${BOLD}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘     ğŸš€ Modern Format Boost v6.5.2                                        â•‘"
    echo "  â•‘     XMPè¾¹è½¦è‡ªåŠ¨åˆå¹¶ + æ™ºèƒ½è´¨é‡åŒ¹é… + SSIMéªŒè¯                            â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BLUE}ğŸ“‹${NC} XMPè‡ªåŠ¨åˆå¹¶  ${BLUE}ğŸ${NC} Appleå…¼å®¹  ${BLUE}ğŸ”„${NC} æ–­ç‚¹ç»­ä¼   ${BLUE}ğŸ¯${NC} SSIMéªŒè¯  ${MAGENTA}ğŸ“Š${NC} å®æ—¶è¿›åº¦"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆ›å»ºç›®å½•ç»“æ„ï¼ˆä¿æŒåŸå§‹å±‚çº§ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
create_directory_structure() {
    local source_dir="$1"
    local target_dir="$2"
    
    # åˆ›å»ºæ ¹ç›®å½•
    mkdir -p "$target_dir"
    
    # é€’å½’å¤åˆ¶ç›®å½•ç»“æ„ï¼ˆåªå¤åˆ¶ç›®å½•ï¼Œä¸å¤åˆ¶æ–‡ä»¶ï¼‰
    find "$source_dir" -type d -print0 | while IFS= read -r -d '' dir; do
        # è®¡ç®—ç›¸å¯¹è·¯å¾„
        local rel_path="${dir#$source_dir}"
        rel_path="${rel_path#/}"  # ç§»é™¤å¼€å¤´çš„æ–œæ 
        
        # åœ¨ç›®æ ‡ç›®å½•ä¸­åˆ›å»ºå¯¹åº”çš„å­ç›®å½•
        if [[ -n "$rel_path" ]]; then
            mkdir -p "$target_dir/$rel_path"
        fi
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¿æŒç›®å½•ç»“æ„çš„å›¾åƒå¤„ç†
# ğŸ”¥ v5.77: ä¿®å¤å­shellé—®é¢˜ï¼Œä½¿ç”¨æ•°ç»„è€Œéç®¡é“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_images_with_structure() {
    # ğŸ”¥ å…³é”®ï¼šä½¿ç”¨æ•°ç»„æ”¶é›†æ–‡ä»¶ï¼Œé¿å…å­shellé—®é¢˜
    local -a files=()
    while IFS= read -r -d '' file; do
        files+=("$file")
    done < <(find "$TARGET_DIR" -type f \( \
        -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \
        -o -iname "*.bmp" -o -iname "*.tiff" -o -iname "*.webp" -o -iname "*.heic" \
    \) -print0)
    
    local total=${#files[@]}
    local current=0
    
    for file in "${files[@]}"; do
        ((current++))
        
        # è®¡ç®—ç›¸å¯¹è·¯å¾„
        local rel_path="${file#$TARGET_DIR}"
        rel_path="${rel_path#/}"
        
        # è®¡ç®—è¾“å‡ºç›®å½•ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
        local output_file="$OUTPUT_DIR/$rel_path"
        local out_dir
        out_dir="$(dirname "$output_file")"
        mkdir -p "$out_dir"
        
        # æ˜¾ç¤ºè¿›åº¦
        print_progress_box "å›¾åƒ" "$current" "$total" "$(basename "$file")" ""
        
        # æ‰§è¡Œè½¬æ¢ï¼ˆæ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼‰
        local img_args=(auto "$file" --explore --match-quality --compress --apple-compat --output "$out_dir")
        [[ "$ULTIMATE_MODE" == true ]] && img_args+=(--ultimate)
        "$IMGQUALITY_HEVC" "${img_args[@]}" </dev/null || true
    done
    
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¿æŒç›®å½•ç»“æ„çš„è§†é¢‘å¤„ç†
# ğŸ”¥ v5.77: ä¿®å¤å­shellé—®é¢˜ï¼Œä½¿ç”¨æ•°ç»„è€Œéç®¡é“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_videos_with_structure() {
    # ğŸ”¥ å…³é”®ï¼šä½¿ç”¨æ•°ç»„æ”¶é›†æ–‡ä»¶ï¼Œé¿å…å­shellé—®é¢˜
    local -a files=()
    while IFS= read -r -d '' file; do
        files+=("$file")
    done < <(find "$TARGET_DIR" -type f \( \
        -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" \
        -o -iname "*.webm" -o -iname "*.m4v" \
    \) -print0)
    
    local total=${#files[@]}
    local current=0
    
    for file in "${files[@]}"; do
        ((current++))
        
        # è®¡ç®—ç›¸å¯¹è·¯å¾„
        local rel_path="${file#$TARGET_DIR}"
        rel_path="${rel_path#/}"
        
        # è®¡ç®—è¾“å‡ºç›®å½•ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
        local output_file="$OUTPUT_DIR/$rel_path"
        local out_dir
        out_dir="$(dirname "$output_file")"
        mkdir -p "$out_dir"
        
        # æ˜¾ç¤ºè¿›åº¦
        print_progress_box "è§†é¢‘" "$current" "$total" "$(basename "$file")" ""
        
        # æ‰§è¡Œè½¬æ¢ï¼ˆæ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼‰
        local vid_args=(auto "$file" --explore --match-quality true --compress --apple-compat --output "$out_dir")
        [[ "$ULTIMATE_MODE" == true ]] && vid_args+=(--ultimate)
        "$VIDQUALITY_HEVC" "${vid_args[@]}" </dev/null || true
    done
    
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é€‰æ‹©è¿è¡Œæ¨¡å¼
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
select_mode() {
    echo -e "${BOLD}è¯·é€‰æ‹©è¾“å‡ºæ¨¡å¼ï¼š${NC} ${DIM}(â†‘â†“/jk é€‰æ‹©, Enter ç¡®è®¤, Q é€€å‡º)${NC}"
    echo ""
    
    select_menu "ğŸš€ åŸåœ°è½¬æ¢ - åˆ é™¤åŸæ–‡ä»¶ï¼ŒèŠ‚çœç©ºé—´" "ğŸ“‚ è¾“å‡ºåˆ°ç›¸é‚»ç›®å½• - ä¿ç•™åŸæ–‡ä»¶ï¼Œå®‰å…¨é¢„è§ˆ"
    
    echo ""
    if [[ $SELECTED -eq 0 ]]; then
        OUTPUT_MODE="inplace"
        echo -e "${GREEN}âœ… å·²é€‰æ‹©ï¼šåŸåœ°è½¬æ¢æ¨¡å¼${NC}"
    else
        OUTPUT_MODE="adjacent"
        local base_name
        base_name=$(basename "$TARGET_DIR")
        OUTPUT_DIR="$(dirname "$TARGET_DIR")/${base_name}_converted"
        
        # ğŸ”¥ v5.76: åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶åŸå§‹ç›®å½•ç»“æ„
        echo -e "${CYAN}ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„...${NC}"
        create_directory_structure "$TARGET_DIR" "$OUTPUT_DIR"
        
        echo -e "${GREEN}âœ… å·²é€‰æ‹©ï¼šè¾“å‡ºåˆ°ç›¸é‚»ç›®å½•ï¼ˆä¿æŒåŸå§‹ç»“æ„ï¼‰${NC}"
        echo -e "   ${DIM}â†’ $OUTPUT_DIR${NC}"
    fi
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è§£æå‘½ä»¤è¡Œå‚æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --ultimate)
                ULTIMATE_MODE=true
                shift
                ;;
            *)
                # ç¬¬ä¸€ä¸ªéflagå‚æ•°ä½œä¸ºç›®æ ‡ç›®å½•
                TARGET_DIR="$1"
                shift
                ;;
        esac
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è·å–ç›®æ ‡ç›®å½•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
get_target_directory() {
    if [[ -z "$TARGET_DIR" ]]; then
        echo -e "${BOLD}è¯·å°†è¦å¤„ç†çš„æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤çª—å£ï¼Œç„¶åæŒ‰å›è½¦ï¼š${NC}"
        read -r TARGET_DIR
        TARGET_DIR="${TARGET_DIR%\"}"
        TARGET_DIR="${TARGET_DIR#\"}"
        TARGET_DIR="${TARGET_DIR%\'}"
        TARGET_DIR="${TARGET_DIR#\'}"
        TARGET_DIR="${TARGET_DIR## }"
        TARGET_DIR="${TARGET_DIR%% }"
    fi
    
    if [[ ! -d "$TARGET_DIR" ]]; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šç›®å½•ä¸å­˜åœ¨: $TARGET_DIR${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}ğŸ“‚${NC} ç›®æ ‡ç›®å½•: ${BOLD}$TARGET_DIR${NC}"
    
    if [[ "$ULTIMATE_MODE" == true ]]; then
        echo -e "${MAGENTA}ğŸ”¥${NC} æé™æ¨¡å¼å·²å¯ç”¨ - æŒç»­æœç´¢ç›´åˆ°SSIMå®Œå…¨é¥±å’Œ"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®‰å…¨æ£€æŸ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
safety_check() {
    case "$TARGET_DIR" in
        "/"|"/System"*|"/usr"*|"/bin"*|"/sbin"*|"$HOME"|"$HOME/Desktop"|"$HOME/Documents")
            echo -e "${RED}âŒ å±é™©ç›®å½•ï¼Œæ‹’ç»å¤„ç†: $TARGET_DIR${NC}"
            exit 1
            ;;
    esac
    
    if [[ "$OUTPUT_MODE" == "inplace" ]]; then
        echo -e "${YELLOW}âš ï¸  å³å°†å¼€å§‹åŸåœ°å¤„ç†ï¼ˆä¼šåˆ é™¤åŸæ–‡ä»¶ï¼‰${NC}"
        echo -ne "${BOLD}ç¡®è®¤ç»§ç»­ï¼Ÿ${NC} ${DIM}(y/N)${NC}: "
        read -r CONFIRM
        if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
            echo -e "${RED}âŒ ç”¨æˆ·å–æ¶ˆ${NC}"
            exit 0
        fi
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç»Ÿè®¡æ–‡ä»¶æ•°é‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
count_files() {
    echo -e "${CYAN}ğŸ“Š ç»Ÿè®¡æ–‡ä»¶...${NC}"
    
    XMP_COUNT=$(find "$TARGET_DIR" -type f -iname "*.xmp" 2>/dev/null | wc -l | tr -d ' ')
    IMG_COUNT=$(find "$TARGET_DIR" -type f \( \
        -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \
        -o -iname "*.bmp" -o -iname "*.tiff" -o -iname "*.webp" -o -iname "*.heic" \
    \) 2>/dev/null | wc -l | tr -d ' ')
    VID_COUNT=$(find "$TARGET_DIR" -type f \( \
        -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" \
        -o -iname "*.webm" -o -iname "*.m4v" \
    \) 2>/dev/null | wc -l | tr -d ' ')
    
    echo -e "  ğŸ“‹ XMP: ${BOLD}$XMP_COUNT${NC}  ğŸ–¼ï¸ å›¾åƒ: ${BOLD}$IMG_COUNT${NC}  ğŸ¬ è§†é¢‘: ${BOLD}$VID_COUNT${NC}"
    
    if [[ $((IMG_COUNT + VID_COUNT)) -eq 0 ]]; then
        echo -e "${RED}âŒ æœªæ‰¾åˆ°æ”¯æŒçš„åª’ä½“æ–‡ä»¶${NC}"
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# XMP åˆå¹¶ (v5.76: å·²æ•´åˆåˆ°è½¬æ¢å·¥å…·ä¸­ï¼Œæ­¤å‡½æ•°ä»…ç”¨äºç‹¬ç«‹åˆå¹¶)
# ğŸ”¥ æ³¨æ„ï¼šimgquality-hevc/vidquality-hevc çš„ copy_metadata() å·²è‡ªåŠ¨åˆå¹¶XMP
# æ­¤å‡½æ•°ç°åœ¨åªåœ¨ç”¨æˆ·æ˜ç¡®éœ€è¦ç‹¬ç«‹åˆå¹¶æ—¶ä½¿ç”¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
merge_xmp_files() {
    # ğŸ”¥ v5.76: è½¬æ¢å·¥å…·å·²è‡ªåŠ¨åˆå¹¶XMPï¼Œè·³è¿‡ç‹¬ç«‹åˆå¹¶é¿å…é‡å¤
    # å¦‚æœç”¨æˆ·åªæƒ³åˆå¹¶XMPè€Œä¸è½¬æ¢ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œ xmp-merge å‘½ä»¤
    [[ $XMP_COUNT -gt 0 ]] && echo -e "${DIM}ğŸ“‹ XMPè¾¹è½¦å°†åœ¨è½¬æ¢æ—¶è‡ªåŠ¨åˆå¹¶${NC}"
    return 0
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¤„ç†å›¾åƒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_images() {
    [[ $IMG_COUNT -eq 0 ]] && return 0

    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚${NC} ${BOLD}ğŸ–¼ï¸  å¤„ç†å›¾åƒ${NC} â”‚ $IMG_COUNT ä¸ªæ–‡ä»¶ â”‚ --explore --match-quality --compress â”‚"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "${DIM}   è¿›åº¦æ¡å°†æ˜¾ç¤º: CRF å€¼ | SSIM | å¤§å°å˜åŒ– | è¿­ä»£æ¬¡æ•° | è€—æ—¶${NC}"
    echo ""

    if [[ "$OUTPUT_MODE" == "inplace" ]]; then
        # åŸåœ°è½¬æ¢æ¨¡å¼
        local args=(auto "$TARGET_DIR" --recursive --explore --match-quality --compress --apple-compat --in-place)
        
        # ğŸ”¥ æ·»åŠ æé™æ¨¡å¼flag
        if [[ "$ULTIMATE_MODE" == true ]]; then
            args+=(--ultimate)
        fi
        
        # ğŸ”¥ v6.2.2: ä¿ç•™ä¿¡å·å¤„ç†ï¼Œåªç¦ç”¨å›æ˜¾å’Œè§„èŒƒæ¨¡å¼
        # å…³é”®ä¿®å¤ï¼šç§»é™¤ -isigï¼Œä¿æŒ Ctrl+C å¯ç”¨
        local original_stty
        original_stty=$(stty -g 2>/dev/null) || original_stty=""
        if [[ -t 0 ]]; then
            # åªç¦ç”¨å›æ˜¾å’Œè§„èŒƒæ¨¡å¼ï¼Œä¿ç•™ä¿¡å·å¤„ç† (isig)
            stty -echo -icanon 2>/dev/null || true
        fi
        
        # æ‰§è¡Œè½¬æ¢
        "$IMGQUALITY_HEVC" "${args[@]}" </dev/null || true
        
        # æ¢å¤åŸå§‹ç»ˆç«¯è®¾ç½®
        if [[ -n "$original_stty" ]]; then
            stty "$original_stty" 2>/dev/null || true
        else
            stty echo icanon 2>/dev/null || true
        fi
    else
        # ç›¸é‚»ç›®å½•æ¨¡å¼ï¼šé€ä¸ªå¤„ç†æ–‡ä»¶ä»¥ä¿æŒç›®å½•ç»“æ„
        process_images_with_structure
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¤„ç†è§†é¢‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_videos() {
    [[ $VID_COUNT -eq 0 ]] && return 0

    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚${NC} ${BOLD}ğŸ¬ å¤„ç†è§†é¢‘${NC} â”‚ $VID_COUNT ä¸ªæ–‡ä»¶ â”‚ --explore --match-quality --compress â”‚"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "${DIM}   è¿›åº¦æ¡å°†æ˜¾ç¤º: CRF å€¼ | SSIM | å¤§å°å˜åŒ– | è¿­ä»£æ¬¡æ•° | è€—æ—¶${NC}"
    echo ""

    if [[ "$OUTPUT_MODE" == "inplace" ]]; then
        # åŸåœ°è½¬æ¢æ¨¡å¼
        local args=(auto "$TARGET_DIR" --recursive --explore --match-quality true --compress --apple-compat --in-place)
        
        # ğŸ”¥ æ·»åŠ æé™æ¨¡å¼flag
        if [[ "$ULTIMATE_MODE" == true ]]; then
            args+=(--ultimate)
        fi
        
        # ğŸ”¥ v6.2.2: ä¿ç•™ä¿¡å·å¤„ç†ï¼Œåªç¦ç”¨å›æ˜¾å’Œè§„èŒƒæ¨¡å¼
        # å…³é”®ä¿®å¤ï¼šç§»é™¤ -isigï¼Œä¿æŒ Ctrl+C å¯ç”¨
        local original_stty
        original_stty=$(stty -g 2>/dev/null) || original_stty=""
        if [[ -t 0 ]]; then
            # åªç¦ç”¨å›æ˜¾å’Œè§„èŒƒæ¨¡å¼ï¼Œä¿ç•™ä¿¡å·å¤„ç† (isig)
            stty -echo -icanon 2>/dev/null || true
        fi
        
        # æ‰§è¡Œè½¬æ¢
        "$VIDQUALITY_HEVC" "${args[@]}" </dev/null || true
        
        # æ¢å¤åŸå§‹ç»ˆç«¯è®¾ç½®
        if [[ -n "$original_stty" ]]; then
            stty "$original_stty" 2>/dev/null || true
        else
            stty echo icanon 2>/dev/null || true
        fi
    else
        # ç›¸é‚»ç›®å½•æ¨¡å¼ï¼šé€ä¸ªå¤„ç†æ–‡ä»¶ä»¥ä¿æŒç›®å½•ç»“æ„
        process_videos_with_structure
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®Œæˆä¿¡æ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_completion() {
    echo ""
    echo -e "${GREEN}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo -e "â”‚     ğŸ‰ å¤„ç†å®Œæˆï¼                                                       â”‚"
    echo -e "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    
    # æ˜¾ç¤ºå¤„ç†æ‘˜è¦
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ğŸ“Š å¤„ç†æ‘˜è¦:"
    echo -e "     ğŸ–¼ï¸  å›¾åƒ: $IMG_COUNT ä¸ª"
    echo -e "     ğŸ¬ è§†é¢‘: $VID_COUNT ä¸ª"
    echo -e "     ğŸ“‹ XMP:  $XMP_COUNT ä¸ª"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [[ "$OUTPUT_MODE" == "adjacent" ]]; then
        echo -e "  ${BLUE}ğŸ“‚${NC} è¾“å‡ºç›®å½•: ${BOLD}$OUTPUT_DIR${NC}"
        echo -ne "  æ˜¯å¦æ‰“å¼€ï¼Ÿ ${DIM}(y/N)${NC}: "
        read -r ans
        [[ "$ans" =~ ^[Yy]$ ]] && open "$OUTPUT_DIR" 2>/dev/null
    fi
    
    echo ""
    echo -e "  ${DIM}æŒ‰ä»»æ„é”®é€€å‡º...${NC}"
    read -rsn1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”¥ v6.2.2: æ”¹è¿›çš„ä¿¡å·å¤„ç† - ç¡®ä¿å­è¿›ç¨‹è¢«æ­£ç¡®ç»ˆæ­¢
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cleanup_and_exit() {
    local exit_code=${1:-130}
    
    # æ¢å¤å…‰æ ‡
    printf "\033[?25h"
    
    # æ¢å¤ç»ˆç«¯è®¾ç½®
    stty echo icanon isig iexten onlcr ixon ixoff 2>/dev/null || true
    
    # ç»ˆæ­¢æ‰€æœ‰å­è¿›ç¨‹
    jobs -p 2>/dev/null | xargs -r kill -TERM 2>/dev/null || true
    
    echo -e "\n${YELLOW}âš ï¸ ç”¨æˆ·ä¸­æ–­ï¼Œæ­£åœ¨æ¸…ç†...${NC}"
    
    # ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    wait 2>/dev/null || true
    
    echo -e "${GREEN}âœ… æ¸…ç†å®Œæˆ${NC}"
    exit "$exit_code"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
main() {
    # ğŸ”¥ v6.2.2: æ”¹è¿›çš„ trap - è°ƒç”¨æ¸…ç†å‡½æ•°
    trap 'cleanup_and_exit 130' INT
    trap 'cleanup_and_exit 143' TERM
    trap 'printf "\033[?25h"; stty echo 2>/dev/null' EXIT
    
    parse_arguments "$@"
    check_tools
    get_target_directory
    show_welcome
    select_mode
    safety_check
    count_files
    merge_xmp_files
    process_images
    process_videos
    show_completion
}

main "$@"
