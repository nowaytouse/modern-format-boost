#!/opt/homebrew/bin/bash
# Modern Format Boost - Drag & Drop Processor v5.70
# 
# ğŸ”¥ v5.70: æ™ºèƒ½ç¼–è¯‘ç³»ç»Ÿ
# - æ—¶é—´æˆ³æ¯”å¯¹ï¼šåªåœ¨æºä»£ç æ›´æ–°æ—¶é‡æ–°ç¼–è¯‘
# - ç‰ˆæœ¬å·è¯†åˆ«ï¼šæ£€æµ‹ç‰ˆæœ¬ä¸åŒ¹é…
# - ä¾èµ–ä¼ æ’­ï¼šshared_utils ä¿®æ”¹è§¦å‘å…¨éƒ¨é‡ç¼–è¯‘
# 
# ä½¿ç”¨æ–¹æ³•ï¼šå°†æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤è„šæœ¬ä¸Šï¼Œæˆ–åŒå‡»åé€‰æ‹©æ–‡ä»¶å¤¹

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# å·¥å…·è·¯å¾„
IMGQUALITY_HEVC="$PROJECT_ROOT/imgquality_hevc/target/release/imgquality-hevc"
VIDQUALITY_HEVC="$PROJECT_ROOT/vidquality_hevc/target/release/vidquality-hevc"
XMP_MERGER="$PROJECT_ROOT/xmp_merger/target/release/xmp-merge"

# æ¨¡å¼è®¾ç½®
OUTPUT_MODE="inplace"
OUTPUT_DIR=""
SELECTED=0

# ç»ˆç«¯é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ğŸ”¥ v5.5: è¿›åº¦æ¡è¾…åŠ©å‡½æ•°
TERM_WIDTH=$(tput cols 2>/dev/null || echo 80)
PROGRESS_LINE=""

# æ¸…é™¤å½“å‰è¡Œå¹¶æ‰“å°
print_progress() {
    printf '\r\033[K%s' "$1"
}

# æ‰“å°å›ºå®šåº•éƒ¨è¿›åº¦æ¡†
print_progress_box() {
    local stage="$1"
    local current="$2"
    local total="$3"
    local file="$4"
    local extra="$5"
    
    local pct=$((current * 100 / total))
    local bar_width=30
    local filled=$((pct * bar_width / 100))
    local empty=$((bar_width - filled))
    
    local bar=""
    for ((i=0; i<filled; i++)); do bar+="â”"; done
    for ((i=0; i<empty; i++)); do bar+="â”€"; done
    
    printf '\r\033[K'
    printf "${CYAN}â”‚${NC} %s ${CYAN}â”‚${NC} [${GREEN}%s${NC}] %d/%d (%d%%) ${CYAN}â”‚${NC} %s ${CYAN}â”‚${NC}" \
        "$stage" "$bar" "$current" "$total" "$pct" "${file:0:30}"
    [[ -n "$extra" ]] && printf " %s" "$extra"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ–¹å‘é”®é€‰æ‹©èœå• (v5.2)
# ä½¿ç”¨å…¨å±€å˜é‡ SELECTED è¿”å›ç»“æœï¼Œé¿å… set -e é—®é¢˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
select_menu() {
    local opt1="$1"
    local opt2="$2"
    SELECTED=0
    
    # éšè—å…‰æ ‡
    printf '\033[?25l'
    
    # ç»˜åˆ¶å‡½æ•°
    draw() {
        if [[ $SELECTED -eq 0 ]]; then
            printf "  \033[32mâ–¶ \033[1m%s\033[0m\n" "$opt1"
            printf "    \033[2m%s\033[0m\n" "$opt2"
        else
            printf "    \033[2m%s\033[0m\n" "$opt1"
            printf "  \033[32mâ–¶ \033[1m%s\033[0m\n" "$opt2"
        fi
    }
    
    # æ¸…é™¤ä¸¤è¡Œ
    clear2() {
        printf '\033[A\033[2K\033[A\033[2K'
    }
    
    draw
    
    while true; do
        # è¯»å–ä¸€ä¸ªå­—ç¬¦
        local c
        IFS= read -rsn1 c 2>/dev/null || c=""
        
        # æ£€æŸ¥ ESC åºåˆ—
        if [[ "$c" == $'\033' ]]; then
            local c2 c3
            IFS= read -rsn1 -t 0.1 c2 2>/dev/null || c2=""
            IFS= read -rsn1 -t 0.1 c3 2>/dev/null || c3=""
            # ä¸Šç®­å¤´: ESC [ A æˆ– ESC O A
            if [[ "$c2" == "[" && "$c3" == "A" ]] || [[ "$c2" == "O" && "$c3" == "A" ]]; then
                SELECTED=$((1 - SELECTED))
                clear2; draw
            # ä¸‹ç®­å¤´: ESC [ B æˆ– ESC O B
            elif [[ "$c2" == "[" && "$c3" == "B" ]] || [[ "$c2" == "O" && "$c3" == "B" ]]; then
                SELECTED=$((1 - SELECTED))
                clear2; draw
            fi
        # Enter
        elif [[ "$c" == "" ]]; then
            break
        # j/k vim é£æ ¼
        elif [[ "$c" == "j" || "$c" == "k" ]]; then
            SELECTED=$((1 - SELECTED))
            clear2; draw
        # æ•°å­— 1/2
        elif [[ "$c" == "1" ]]; then
            SELECTED=0; clear2; draw
        elif [[ "$c" == "2" ]]; then
            SELECTED=1; clear2; draw
        # q é€€å‡º
        elif [[ "$c" == "q" || "$c" == "Q" ]]; then
            printf '\033[?25h'
            echo -e "\n${RED}âŒ ç”¨æˆ·å–æ¶ˆ${NC}"
            exit 0
        fi
    done
    
    printf '\033[?25h'
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ£€æŸ¥å·¥å…·
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
check_tools() {
    # ğŸ”¥ v5.70: æ™ºèƒ½ç¼–è¯‘ - åªåœ¨æºä»£ç æ›´æ–°æ—¶é‡æ–°ç¼–è¯‘
    "$PROJECT_ROOT/smart_build.sh" || {
        echo -e "${RED}âŒ Build failed${NC}"
        exit 1
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_welcome() {
    printf '\033[2J\033[H'
    echo ""
    echo -e "${CYAN}${BOLD}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘     ğŸš€ Modern Format Boost v5.5                                          â•‘"
    echo "  â•‘     å…¨é¢æ”¹è¿›è¿›åº¦æ˜¾ç¤º - å›ºå®šåº•éƒ¨è¿›åº¦æ¡ + è¯¦ç»†å‚æ•°                         â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BLUE}ğŸ“‹${NC} XMPåˆå¹¶  ${BLUE}ğŸ${NC} Appleå…¼å®¹  ${BLUE}ğŸ”„${NC} æ–­ç‚¹ç»­ä¼   ${BLUE}ğŸ¯${NC} v4.13ç®—æ³•  ${MAGENTA}ğŸ“Š${NC} å®æ—¶è¿›åº¦"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é€‰æ‹©è¿è¡Œæ¨¡å¼
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
select_mode() {
    echo -e "${BOLD}è¯·é€‰æ‹©è¾“å‡ºæ¨¡å¼ï¼š${NC} ${DIM}(â†‘â†“/jk é€‰æ‹©, Enter ç¡®è®¤, Q é€€å‡º)${NC}"
    echo ""
    
    select_menu "ğŸš€ åŸåœ°è½¬æ¢ - åˆ é™¤åŸæ–‡ä»¶ï¼ŒèŠ‚çœç©ºé—´" "ğŸ“‚ è¾“å‡ºåˆ°ç›¸é‚»ç›®å½• - ä¿ç•™åŸæ–‡ä»¶ï¼Œå®‰å…¨é¢„è§ˆ"
    
    echo ""
    if [[ $SELECTED -eq 0 ]]; then
        OUTPUT_MODE="inplace"
        echo -e "${GREEN}âœ… å·²é€‰æ‹©ï¼šåŸåœ°è½¬æ¢æ¨¡å¼${NC}"
    else
        OUTPUT_MODE="adjacent"
        local base_name
        base_name=$(basename "$TARGET_DIR")
        OUTPUT_DIR="$(dirname "$TARGET_DIR")/${base_name}_converted"
        mkdir -p "$OUTPUT_DIR"
        echo -e "${GREEN}âœ… å·²é€‰æ‹©ï¼šè¾“å‡ºåˆ°ç›¸é‚»ç›®å½•${NC}"
        echo -e "   ${DIM}â†’ $OUTPUT_DIR${NC}"
    fi
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è·å–ç›®æ ‡ç›®å½•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
get_target_directory() {
    if [[ $# -gt 0 ]]; then
        TARGET_DIR="$1"
    else
        echo -e "${BOLD}è¯·å°†è¦å¤„ç†çš„æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤çª—å£ï¼Œç„¶åæŒ‰å›è½¦ï¼š${NC}"
        read -r TARGET_DIR
        TARGET_DIR="${TARGET_DIR%\"}"
        TARGET_DIR="${TARGET_DIR#\"}"
        TARGET_DIR="${TARGET_DIR%\'}"
        TARGET_DIR="${TARGET_DIR#\'}"
        TARGET_DIR="${TARGET_DIR## }"
        TARGET_DIR="${TARGET_DIR%% }"
    fi
    
    if [[ ! -d "$TARGET_DIR" ]]; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šç›®å½•ä¸å­˜åœ¨: $TARGET_DIR${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}ğŸ“‚${NC} ç›®æ ‡ç›®å½•: ${BOLD}$TARGET_DIR${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®‰å…¨æ£€æŸ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
safety_check() {
    case "$TARGET_DIR" in
        "/"|"/System"*|"/usr"*|"/bin"*|"/sbin"*|"$HOME"|"$HOME/Desktop"|"$HOME/Documents")
            echo -e "${RED}âŒ å±é™©ç›®å½•ï¼Œæ‹’ç»å¤„ç†: $TARGET_DIR${NC}"
            exit 1
            ;;
    esac
    
    if [[ "$OUTPUT_MODE" == "inplace" ]]; then
        echo -e "${YELLOW}âš ï¸  å³å°†å¼€å§‹åŸåœ°å¤„ç†ï¼ˆä¼šåˆ é™¤åŸæ–‡ä»¶ï¼‰${NC}"
        echo -ne "${BOLD}ç¡®è®¤ç»§ç»­ï¼Ÿ${NC} ${DIM}(y/N)${NC}: "
        read -r CONFIRM
        if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
            echo -e "${RED}âŒ ç”¨æˆ·å–æ¶ˆ${NC}"
            exit 0
        fi
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç»Ÿè®¡æ–‡ä»¶æ•°é‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
count_files() {
    echo -e "${CYAN}ğŸ“Š ç»Ÿè®¡æ–‡ä»¶...${NC}"
    
    XMP_COUNT=$(find "$TARGET_DIR" -type f -iname "*.xmp" 2>/dev/null | wc -l | tr -d ' ')
    IMG_COUNT=$(find "$TARGET_DIR" -type f \( \
        -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \
        -o -iname "*.bmp" -o -iname "*.tiff" -o -iname "*.webp" -o -iname "*.heic" \
    \) 2>/dev/null | wc -l | tr -d ' ')
    VID_COUNT=$(find "$TARGET_DIR" -type f \( \
        -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" \
        -o -iname "*.webm" -o -iname "*.m4v" \
    \) 2>/dev/null | wc -l | tr -d ' ')
    
    echo -e "  ğŸ“‹ XMP: ${BOLD}$XMP_COUNT${NC}  ğŸ–¼ï¸ å›¾åƒ: ${BOLD}$IMG_COUNT${NC}  ğŸ¬ è§†é¢‘: ${BOLD}$VID_COUNT${NC}"
    
    if [[ $((IMG_COUNT + VID_COUNT)) -eq 0 ]]; then
        echo -e "${RED}âŒ æœªæ‰¾åˆ°æ”¯æŒçš„åª’ä½“æ–‡ä»¶${NC}"
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# XMP åˆå¹¶
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
merge_xmp_files() {
    [[ $XMP_COUNT -eq 0 ]] && return 0
    command -v exiftool &>/dev/null || { echo -e "${YELLOW}âš ï¸ ExifTool æœªå®‰è£…${NC}"; return 0; }
    echo -e "${CYAN}ğŸ“‹ åˆå¹¶ XMP å…ƒæ•°æ®...${NC}"
    "$XMP_MERGER" --delete-xmp "$TARGET_DIR" || true
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¤„ç†å›¾åƒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_images() {
    [[ $IMG_COUNT -eq 0 ]] && return 0

    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚${NC} ${BOLD}ğŸ–¼ï¸  å¤„ç†å›¾åƒ${NC} â”‚ $IMG_COUNT ä¸ªæ–‡ä»¶ â”‚ --explore --match-quality --compress â”‚"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "${DIM}   è¿›åº¦æ¡å°†æ˜¾ç¤º: CRF å€¼ | SSIM | å¤§å°å˜åŒ– | è¿­ä»£æ¬¡æ•° | è€—æ—¶${NC}"
    echo ""

    # ğŸ”¥ v5.35: ä½¿ç”¨ --explore --match-quality --compress ç»„åˆ
    local args=(auto "$TARGET_DIR" --recursive --explore --match-quality --compress --apple-compat)
    [[ "$OUTPUT_MODE" == "inplace" ]] && args+=(--in-place) || args+=(--output "$OUTPUT_DIR")

    # ğŸ”¥ v5.41: æ¿€è¿›çš„é”®ç›˜è¾“å…¥é˜²æŠ¤ï¼ˆå®Œå…¨ç¦ç”¨ç»ˆç«¯è¾“å…¥ï¼‰
    # å…³é”®æ´å¯Ÿï¼šéœ€è¦åœ¨å¤šä¸ªå±‚é¢å®Œå…¨é˜»æ­¢é”®ç›˜è¾“å…¥

    # ä¿å­˜åŸå§‹ç»ˆç«¯è®¾ç½®
    local original_stty
    original_stty=$(stty -g 2>/dev/null) || original_stty=""

    # 1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦çº§åˆ«ï¼šå…³é—­æ‰€æœ‰è¾“å…¥æº
    exec 0</dev/null          # stdin é‡å®šå‘åˆ° /dev/nullï¼ˆå®Œå…¨ç¦æ­¢è¾“å…¥ï¼‰

    # 2ï¸âƒ£ ç»ˆç«¯çº§åˆ«ï¼šå®Œå…¨ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¨¡å¼
    if [[ -t 1 ]]; then
        # ç¦ç”¨ï¼šecho, canonical, ä¿¡å·å¤„ç†, ç‰¹æ®Šå­—ç¬¦, newlineè½¬æ¢, æµæ§åˆ¶
        stty -echo -icanon -isig -iexten -onlcr -ixon -ixoff 2>/dev/null || true
        # è®¾ç½®æœ€å°è¯»å–å­—èŠ‚æ•°ä¸º0ï¼ˆéé˜»å¡ï¼‰
        stty min 0 time 0 2>/dev/null || true
    fi

    # 3ï¸âƒ£ ç¯å¢ƒçº§åˆ«ï¼šå‘Šè¯‰ç¨‹åºç¦ç”¨äº¤äº’
    TERM=dumb LANG=C LC_ALL=C "$IMGQUALITY_HEVC" "${args[@]}" || true

    # æ¢å¤åŸå§‹ç»ˆç«¯è®¾ç½®
    if [[ -n "$original_stty" ]]; then
        stty "$original_stty" 2>/dev/null || true
    else
        stty echo icanon isig iexten onlcr ixon ixoff 2>/dev/null || true
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¤„ç†è§†é¢‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
process_videos() {
    [[ $VID_COUNT -eq 0 ]] && return 0

    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚${NC} ${BOLD}ğŸ¬ å¤„ç†è§†é¢‘${NC} â”‚ $VID_COUNT ä¸ªæ–‡ä»¶ â”‚ --explore --match-quality --compress â”‚"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "${DIM}   è¿›åº¦æ¡å°†æ˜¾ç¤º: CRF å€¼ | SSIM | å¤§å°å˜åŒ– | è¿­ä»£æ¬¡æ•° | è€—æ—¶${NC}"
    echo ""

    # ğŸ”¥ v5.5: ä½¿ç”¨ --explore --match-quality --compress ç»„åˆ
    local args=(auto "$TARGET_DIR" --recursive --explore --match-quality true --compress --apple-compat)
    [[ "$OUTPUT_MODE" == "inplace" ]] && args+=(--in-place) || args+=(--output "$OUTPUT_DIR")

    # ğŸ”¥ v5.41: æ¿€è¿›çš„é”®ç›˜è¾“å…¥é˜²æŠ¤ï¼ˆå®Œå…¨ç¦ç”¨ç»ˆç«¯è¾“å…¥ï¼‰
    # å…³é”®æ´å¯Ÿï¼šéœ€è¦åœ¨å¤šä¸ªå±‚é¢å®Œå…¨é˜»æ­¢é”®ç›˜è¾“å…¥

    # ä¿å­˜åŸå§‹ç»ˆç«¯è®¾ç½®
    local original_stty
    original_stty=$(stty -g 2>/dev/null) || original_stty=""

    # 1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦çº§åˆ«ï¼šå…³é—­æ‰€æœ‰è¾“å…¥æº
    exec 0</dev/null          # stdin é‡å®šå‘åˆ° /dev/nullï¼ˆå®Œå…¨ç¦æ­¢è¾“å…¥ï¼‰

    # 2ï¸âƒ£ ç»ˆç«¯çº§åˆ«ï¼šå®Œå…¨ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¨¡å¼
    if [[ -t 1 ]]; then
        # ç¦ç”¨ï¼šecho, canonical, ä¿¡å·å¤„ç†, ç‰¹æ®Šå­—ç¬¦, newlineè½¬æ¢, æµæ§åˆ¶
        stty -echo -icanon -isig -iexten -onlcr -ixon -ixoff 2>/dev/null || true
        # è®¾ç½®æœ€å°è¯»å–å­—èŠ‚æ•°ä¸º0ï¼ˆéé˜»å¡ï¼‰
        stty min 0 time 0 2>/dev/null || true
    fi

    # 3ï¸âƒ£ ç¯å¢ƒçº§åˆ«ï¼šå‘Šè¯‰ç¨‹åºç¦ç”¨äº¤äº’
    TERM=dumb LANG=C LC_ALL=C "$VIDQUALITY_HEVC" "${args[@]}" || true

    # æ¢å¤åŸå§‹ç»ˆç«¯è®¾ç½®
    if [[ -n "$original_stty" ]]; then
        stty "$original_stty" 2>/dev/null || true
    else
        stty echo icanon isig iexten onlcr ixon ixoff 2>/dev/null || true
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®Œæˆä¿¡æ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_completion() {
    echo ""
    echo -e "${GREEN}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo -e "â”‚     ğŸ‰ å¤„ç†å®Œæˆï¼                                                       â”‚"
    echo -e "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    
    # æ˜¾ç¤ºå¤„ç†æ‘˜è¦
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ğŸ“Š å¤„ç†æ‘˜è¦:"
    echo -e "     ğŸ–¼ï¸  å›¾åƒ: $IMG_COUNT ä¸ª"
    echo -e "     ğŸ¬ è§†é¢‘: $VID_COUNT ä¸ª"
    echo -e "     ğŸ“‹ XMP:  $XMP_COUNT ä¸ª"
    echo -e "  ${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [[ "$OUTPUT_MODE" == "adjacent" ]]; then
        echo -e "  ${BLUE}ğŸ“‚${NC} è¾“å‡ºç›®å½•: ${BOLD}$OUTPUT_DIR${NC}"
        echo -ne "  æ˜¯å¦æ‰“å¼€ï¼Ÿ ${DIM}(y/N)${NC}: "
        read -r ans
        [[ "$ans" =~ ^[Yy]$ ]] && open "$OUTPUT_DIR" 2>/dev/null
    fi
    
    echo ""
    echo -e "  ${DIM}æŒ‰ä»»æ„é”®é€€å‡º...${NC}"
    read -rsn1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
main() {
    trap 'printf "\033[?25h"; echo -e "\n${YELLOW}âš ï¸ ä¸­æ–­${NC}"' INT TERM
    
    check_tools
    get_target_directory "$@"
    show_welcome
    select_mode
    safety_check
    count_files
    merge_xmp_files
    process_images
    process_videos
    show_completion
}

main "$@"
