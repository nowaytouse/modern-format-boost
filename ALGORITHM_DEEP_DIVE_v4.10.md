# Algorithm Deep Dive v4.10 - æ ¸å¿ƒæ€§èƒ½çªç ´

## ğŸ”¥ v4.10 æ ¸å¿ƒæ”¹è¿›ï¼šåˆ†ç¦»ç¼–ç å’ŒSSIMè®¡ç®—

### é—®é¢˜å‘ç°

v4.9 çš„è‡´å‘½è®¾è®¡ç¼ºé™·ï¼š**æ¯æ¬¡ç¼–ç åéƒ½è®¡ç®— SSIM**

```
169MB è§†é¢‘çš„å¤„ç†æµç¨‹ (v4.9):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿­ä»£ 1: ç¼–ç  CRF 40 (~5åˆ†é’Ÿ) + SSIM (~5åˆ†é’Ÿ) = 10åˆ†é’Ÿ â”‚
â”‚ è¿­ä»£ 2: ç¼–ç  CRF 37 (~5åˆ†é’Ÿ) + SSIM (~5åˆ†é’Ÿ) = 10åˆ†é’Ÿ â”‚
â”‚ è¿­ä»£ 3: ç¼–ç  CRF 38 (~5åˆ†é’Ÿ) + SSIM (~5åˆ†é’Ÿ) = 10åˆ†é’Ÿ â”‚
â”‚ ...                                                   â”‚
â”‚ è¿­ä»£ 14: ç¼–ç  + SSIM                         = 10åˆ†é’Ÿ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: 14 Ã— 10åˆ†é’Ÿ = 140åˆ†é’Ÿï¼                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ´å¯Ÿ

å¯¹äº `--compress --match-quality` ç»„åˆï¼š
- **ç›®æ ‡**ï¼šæ‰¾åˆ°æœ€ä½èƒ½å‹ç¼©çš„ CRFï¼ˆ= æœ€é«˜è´¨é‡ï¼‰
- **å…³é”®**ï¼šå‹ç¼©è¾¹ç•Œæ˜¯ç¡®å®šçš„ï¼Œåªéœ€è¦éªŒè¯è¾¹ç•Œç‚¹çš„ SSIM
- **ä¼˜åŒ–**ï¼šPhase 1 åªçœ‹å¤§å°ï¼ŒPhase 2 åªç®—ä¸€æ¬¡ SSIM

### v4.10 è§£å†³æ–¹æ¡ˆ

```
169MB è§†é¢‘çš„å¤„ç†æµç¨‹ (v4.10):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: çº¯å¤§å°æœç´¢ï¼ˆä¸ç®— SSIMï¼‰                      â”‚
â”‚   è¿­ä»£ 1: ç¼–ç  CRF 35 (~5åˆ†é’Ÿ) â†’ Size: +5%           â”‚
â”‚   è¿­ä»£ 2: ç¼–ç  CRF 40 (~5åˆ†é’Ÿ) â†’ Size: -20%          â”‚
â”‚   è¿­ä»£ 3: ç¼–ç  CRF 37 (~5åˆ†é’Ÿ) â†’ Size: -8%           â”‚
â”‚   è¿­ä»£ 4: ç¼–ç  CRF 36 (~5åˆ†é’Ÿ) â†’ Size: -3% âœ“ è¾¹ç•Œ    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase 2: è¾¹ç•Œ SSIM éªŒè¯                              â”‚
â”‚   è®¡ç®— CRF 36 çš„ SSIM (~5åˆ†é’Ÿ) â†’ 0.9856              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: 4 Ã— 5åˆ†é’Ÿ + 1 Ã— 5åˆ†é’Ÿ = 25åˆ†é’Ÿï¼               â”‚
â”‚ èŠ‚çœ: (140 - 25) / 140 = 82%                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç®—æ³•å¯¹æ¯”

### v4.9 vs v4.10

| æŒ‡æ ‡ | v4.9 | v4.10 | æ”¹è¿› |
|------|------|-------|------|
| ç¼–ç æ¬¡æ•° | ~14 | ~6 | -57% |
| SSIMè®¡ç®—æ¬¡æ•° | ~14 | **1** | **-93%** |
| æ€»è€—æ—¶ (169MB) | ~140åˆ†é’Ÿ | ~25åˆ†é’Ÿ | **-82%** |

### ä¸ºä»€ä¹ˆå¯ä»¥åªç®—ä¸€æ¬¡ SSIMï¼Ÿ

```
CRF ä¸å‹ç¼©/è´¨é‡çš„å…³ç³»ï¼š

CRF:    35 â”€â”€â”€â”€ 36 â”€â”€â”€â”€ 37 â”€â”€â”€â”€ 38 â”€â”€â”€â”€ 39 â”€â”€â”€â”€ 40
        â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Size:  +10%   +2%     -5%    -12%    -18%    -25%
        â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
       ä¸å‹ç¼©  ä¸å‹ç¼©  â† è¾¹ç•Œ â†’  å‹ç¼©    å‹ç¼©    å‹ç¼©
                         â”‚
                         â””â”€â”€ æœ€é«˜è´¨é‡çš„å‹ç¼©ç‚¹
                         â””â”€â”€ åªéœ€éªŒè¯è¿™ä¸€ç‚¹çš„ SSIMï¼
```

**å…³é”®æ´å¯Ÿ**ï¼š
- CRF è¶Šä½ â†’ è´¨é‡è¶Šé«˜ â†’ æ–‡ä»¶è¶Šå¤§
- å‹ç¼©è¾¹ç•Œ = æœ€ä½èƒ½å‹ç¼©çš„ CRF = **æœ€é«˜è´¨é‡çš„å‹ç¼©ç‚¹**
- ä¸éœ€è¦æ¯”è¾ƒå¤šä¸ªç‚¹çš„ SSIMï¼Œè¾¹ç•Œç‚¹å°±æ˜¯æœ€ä¼˜è§£

---

## ä»£ç å®ç°

### v4.10 æ ¸å¿ƒæ”¹åŠ¨

```rust
fn explore_precise_quality_match_with_compression(&self) -> Result<ExploreResult> {
    // ğŸ”¥ v4.10: åˆ†ç¦»çš„ç¼“å­˜
    let mut size_cache: HashMap<i32, u64> = HashMap::new();
    let mut quality_cache: HashMap<i32, Quality> = HashMap::new();

    // Phase 1: çº¯å¤§å°æœç´¢ï¼ˆä¸è®¡ç®— SSIMï¼‰
    log!("ğŸ“ Phase 1: Size-only binary search (NO SSIM calculation)");

    // æµ‹è¯• initial_crf
    let initial_size = encode_size_only(initial_crf)?;
    if initial_size < input_size {
        // æ—©æœŸé€€å‡ºï¼šinitial_crf å°±èƒ½å‹ç¼©
        let quality = validate_ssim(initial_crf)?;  // åªç®—ä¸€æ¬¡
        return Ok(result);
    }

    // äºŒåˆ†æœç´¢æ‰¾å‹ç¼©è¾¹ç•Œï¼ˆåªçœ‹å¤§å°ï¼‰
    while high - low > 0.5 {
        let mid = (low + high) / 2.0;
        let size = encode_size_only(mid)?;  // åªç¼–ç ï¼Œä¸ç®— SSIM

        if size < input_size {
            boundary_crf = mid;
            high = mid;
        } else {
            low = mid;
        }
    }

    // Phase 2: è¾¹ç•Œ SSIM éªŒè¯ï¼ˆåªç®—ä¸€æ¬¡ï¼‰
    log!("ğŸ“ Phase 2: SSIM validation at boundary");
    let quality = validate_ssim(boundary_crf)?;  // åªç®—ä¸€æ¬¡ï¼

    return Ok(result);
}
```

---

## æ—©æœŸç»ˆæ­¢ä¼˜åŒ–

### åœºæ™¯ 1: initial_crf å°±èƒ½å‹ç¼©

```
å¦‚æœ initial_crf (å¦‚ CRF 35) å°±èƒ½å‹ç¼©ï¼š
- è¿™å·²ç»æ˜¯æœ€é«˜è´¨é‡çš„é€‰æ‹©
- ä¸éœ€è¦æœç´¢æ›´é«˜ CRFï¼ˆæ›´ä½è´¨é‡ï¼‰
- ç›´æ¥è¿”å›ï¼Œåªéœ€ 1 æ¬¡ç¼–ç  + 1 æ¬¡ SSIM = 10åˆ†é’Ÿ
```

### åœºæ™¯ 2: max_crf éƒ½æ— æ³•å‹ç¼©

```
å¦‚æœ max_crf (å¦‚ CRF 40) éƒ½æ— æ³•å‹ç¼©ï¼š
- æ–‡ä»¶æœ¬èº«å·²ç»æ˜¯é«˜åº¦å‹ç¼©çš„
- æŠ¥å‘Š"æ— æ³•å‹ç¼©"ï¼Œåªéœ€ 2 æ¬¡ç¼–ç  = 10åˆ†é’Ÿ
```

### åœºæ™¯ 3: æ­£å¸¸äºŒåˆ†æœç´¢

```
å…¸å‹åœºæ™¯ï¼š
- è¾¹ç•Œæµ‹è¯•ï¼š2 æ¬¡ç¼–ç 
- äºŒåˆ†æœç´¢ï¼š~4 æ¬¡ç¼–ç 
- SSIM éªŒè¯ï¼š1 æ¬¡
- æ€»è®¡ï¼š~6 æ¬¡ç¼–ç  + 1 æ¬¡ SSIM = 35åˆ†é’Ÿ
```

---

## è¾“å‡ºç¤ºä¾‹

### v4.10 è¾“å‡º

```
ğŸ”¬ Quality + Compress v4.10 (Hevc)
   ğŸ“ Input: 177216937 bytes (169.01 MB)
   ğŸ¯ Goal: HIGHEST SSIM with output < input
   ğŸ’¡ Strategy: Size-first search, then SSIM validation
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“ Phase 1: Size-only binary search (NO SSIM calculation)
   ğŸ”„ Testing initial CRF 35.0...
      â³ ğŸš€ GPU (Apple VideoToolbox) 100.0% | 326.3s/326.3s | 221fps | 3.69x
      âœ… Encoding complete
      Size: +5.2%
   ğŸ”„ Testing max CRF 40.0...
      â³ ğŸš€ GPU (Apple VideoToolbox) 100.0% | 326.3s/326.3s | 221fps | 3.69x
      âœ… Encoding complete
      Size: -23.5%
   ğŸ“ Binary search for compression boundary...
   ğŸ”„ Testing CRF 37.5...
      Size: -8.3%
      âœ… Compresses (-8.3%), trying lower CRF
   ğŸ”„ Testing CRF 36.0...
      Size: -2.1%
      âœ… Compresses (-2.1%), trying lower CRF
   ğŸ”„ Testing CRF 35.5...
      Size: +1.5%
      âŒ Too large (+1.5%), trying higher CRF
   ğŸ“ Compression boundary: CRF 36.0
   ğŸ“ Phase 2: SSIM validation at boundary
   ğŸ“Š Calculating SSIM for CRF 36.0...
      ğŸ“Š Calculating SSIM... 100%
      ğŸ“Š SSIM: 0.985634
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š RESULT: CRF 36.0, SSIM 0.985634 âœ… Good, Size -2.1%
      âœ… Saved 3722155 bytes (3.55 MB)
   ğŸ“ˆ Iterations: 5 (SSIM calculated only 1 time)
```

---

## æ€»ç»“

### v4.10 æ ¸å¿ƒæ”¹è¿›

| æ”¹è¿› | æ•ˆæœ |
|------|------|
| åˆ†ç¦»ç¼–ç å’Œ SSIM è®¡ç®— | SSIM è®¡ç®—æ¬¡æ•°ä» 14 â†’ 1 |
| ä¸¤é˜¶æ®µæœç´¢ç­–ç•¥ | Phase 1 åªçœ‹å¤§å°ï¼ŒPhase 2 åªéªŒè¯è¾¹ç•Œ |
| æ—©æœŸç»ˆæ­¢ | initial_crf èƒ½å‹ç¼©æ—¶ç›´æ¥è¿”å› |
| GPU åŠ é€Ÿ | ç¼–ç é€Ÿåº¦ 3-4x æå‡ |

### æ—¶é—´èŠ‚çœ

| åœºæ™¯ | v4.9 | v4.10 | èŠ‚çœ |
|------|------|-------|------|
| 169MB è§†é¢‘ | ~140åˆ†é’Ÿ | ~25åˆ†é’Ÿ | 82% |
| initial_crf èƒ½å‹ç¼© | ~20åˆ†é’Ÿ | ~10åˆ†é’Ÿ | 50% |
| æ— æ³•å‹ç¼© | ~20åˆ†é’Ÿ | ~10åˆ†é’Ÿ | 50% |

### è®¾è®¡åŸåˆ™

1. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šç¼–ç å’Œè´¨é‡éªŒè¯æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œ
2. **å»¶è¿Ÿè®¡ç®—**ï¼šSSIM åªåœ¨å¿…è¦æ—¶è®¡ç®—
3. **è¾¹ç•Œæ€ç»´**ï¼šå‹ç¼©è¾¹ç•Œ = æœ€ä¼˜è§£ï¼Œæ— éœ€éå†
4. **æ—©æœŸç»ˆæ­¢**ï¼šèƒ½ç¡®å®šç»“æœæ—¶ç«‹å³è¿”å›
