# Modern Format Boost v4.7 - Bug åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## ğŸ”´ ä¸¥é‡ Bug

### Bug #1: `explore_size_only` äºŒåˆ†æœç´¢æ–¹å‘é”™è¯¯

**ä½ç½®**: `video_explorer.rs` çº¦ 460-470 è¡Œ

**é—®é¢˜ä»£ç **:
```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œå°è¯•æ›´é«˜ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
    best_crf = mid as f32;
    best_size = size;
    low = mid;  // âœ… æ­£ç¡®ï¼šå¾€æ›´é«˜ CRF æœç´¢
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´é«˜ CRF
    high = mid;  // âŒ é”™è¯¯ï¼åº”è¯¥æ˜¯ low = mid
}
```

**åˆ†æ**:
- **ç›®æ ‡**: æ‰¾åˆ°èƒ½å‹ç¼©çš„**æœ€é«˜** CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰
- **CRF ç‰¹æ€§**: CRF è¶Šé«˜ â†’ æ–‡ä»¶è¶Šå° â†’ è´¨é‡è¶Šä½
- **å½“ size >= input_size æ—¶**: è¯´æ˜å½“å‰ CRF å¤ªä½ï¼Œæ–‡ä»¶å¤ªå¤§ï¼Œéœ€è¦**æé«˜** CRF
- **é”™è¯¯**: `high = mid` ä¼šè®©æœç´¢å¾€**æ›´ä½** CRF æ–¹å‘èµ°ï¼Œè¿™æ˜¯åçš„ï¼

**æ­£ç¡®é€»è¾‘**:
```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œè®°å½•å¹¶å°è¯•æ›´ä½ CRFï¼ˆæ›´é«˜è´¨é‡ï¼‰
    best_crf = mid as f32;
    best_size = size;
    high = mid;  // å¾€æ›´ä½ CRF æœç´¢ï¼ˆæ›´é«˜è´¨é‡ï¼‰
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´é«˜ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
    low = mid;   // å¾€æ›´é«˜ CRF æœç´¢
}
```

**å½±å“**: æœç´¢æ–¹å‘å®Œå…¨åäº†ï¼Œå¯èƒ½å¯¼è‡´ï¼š
1. æ‰¾ä¸åˆ°æœ€ä¼˜ CRF
2. è¿­ä»£æ¬¡æ•°å¢åŠ 
3. æœ€ç»ˆç»“æœä¸æ˜¯æœ€å°æ–‡ä»¶

---

### Bug #2: `explore_compress_only` ç›®æ ‡å®šä¹‰æ··ä¹±

**ä½ç½®**: `video_explorer.rs` çº¦ 570-650 è¡Œ

**é—®é¢˜**: å‡½æ•°æ³¨é‡Šè¯´"æ‰¾æœ€ä½èƒ½å‹ç¼©çš„ CRF"ï¼Œä½†å®é™…åº”è¯¥æ˜¯"æ‰¾æœ€é«˜èƒ½å‹ç¼©çš„ CRF"

**åˆ†æ**:
- `--compress` çš„ç›®æ ‡æ˜¯ï¼šåªè¦è¾“å‡º < è¾“å…¥å°±è¡Œ
- åº”è¯¥æ‰¾**æœ€ä½** CRFï¼ˆæœ€é«˜è´¨é‡ï¼‰è¿˜æ˜¯**æœ€é«˜** CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰ï¼Ÿ
- æ ¹æ® flag è¯­ä¹‰ï¼Œ`--compress` åº”è¯¥æ‰¾**æœ€ä½èƒ½å‹ç¼©çš„ CRF**ï¼ˆä¿è¯è´¨é‡æœ€é«˜ï¼‰
- ä½† `--explore` æ‰æ˜¯æ‰¾æœ€å°æ–‡ä»¶

**å½“å‰ä»£ç é€»è¾‘**:
```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œå°è¯•æ›´ä½ CRF
    best_crf = Some(mid);
    high = mid;  // âœ… æ­£ç¡®ï¼šå¾€æ›´ä½ CRF æœç´¢
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´é«˜ CRF
    low = mid;   // âœ… æ­£ç¡®
}
```

**ç»“è®º**: è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œä½†æ³¨é‡Šå’Œç›®æ ‡æè¿°æœ‰æ­§ä¹‰ã€‚

---

### Bug #3: `explore_size_only` vs `explore_compress_only` ç›®æ ‡æ··æ·†

**é—®é¢˜**: ä¸¤ä¸ªå‡½æ•°çš„ç›®æ ‡å®šä¹‰ä¸æ¸…æ™°

| å‡½æ•° | å½“å‰ç›®æ ‡ | åº”è¯¥çš„ç›®æ ‡ |
|------|----------|------------|
| `explore_size_only` | æ‰¾æœ€é«˜èƒ½å‹ç¼©çš„ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰ | âœ… æ­£ç¡® |
| `explore_compress_only` | æ‰¾æœ€ä½èƒ½å‹ç¼©çš„ CRFï¼ˆæœ€é«˜è´¨é‡ï¼‰ | âœ… æ­£ç¡® |

**ä½†æ˜¯**ï¼š`explore_size_only` çš„äºŒåˆ†æœç´¢æ–¹å‘æ˜¯é”™çš„ï¼

---

### Bug #4: `explore_compress_with_quality` æœç´¢æ–¹å‘é—®é¢˜

**ä½ç½®**: `video_explorer.rs` çº¦ 700-750 è¡Œ

**é—®é¢˜ä»£ç **:
```rust
// Phase 1: äºŒåˆ†æœç´¢æ‰¾å‹ç¼©è¾¹ç•Œ
if size < self.input_size {
    compress_boundary = Some(mid as f32);
    high = mid;  // å¾€æ›´ä½ CRF æœç´¢
} else {
    low = mid;   // å¾€æ›´é«˜ CRF æœç´¢
}
```

**åˆ†æ**: è¿™é‡Œçš„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºç›®æ ‡æ˜¯æ‰¾**æœ€ä½èƒ½å‹ç¼©çš„ CRF**ã€‚

---

## ğŸŸ¡ é€»è¾‘ç¼ºé™·

### ç¼ºé™· #1: äºŒåˆ†æœç´¢ç»ˆæ­¢æ¡ä»¶ä¸ä¸€è‡´

**é—®é¢˜**: ä¸åŒå‡½æ•°ä½¿ç”¨ä¸åŒçš„ç»ˆæ­¢æ¡ä»¶

| å‡½æ•° | ç»ˆæ­¢æ¡ä»¶ |
|------|----------|
| `explore_size_only` | `high - low > 1.0` |
| `explore_compress_only` | `high - low > 0.5` |
| `explore_compress_with_quality` | `high - low > 1.0` |
| `explore_precise_quality_match` | `high - low > 1.0` |

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `precision::FINE_STEP` å¸¸æ•°

---

### ç¼ºé™· #2: ç¼“å­˜æœºåˆ¶ä¸ä¸€è‡´

**é—®é¢˜**: åªæœ‰ `explore_precise_quality_match` ä½¿ç”¨äº†ç¼“å­˜

```rust
let mut tested_crfs: HashMap<i32, (u64, Quality)> = HashMap::new();
```

å…¶ä»–å‡½æ•°æ²¡æœ‰ç¼“å­˜ï¼Œå¯èƒ½å¯¼è‡´é‡å¤ç¼–ç ã€‚

**å»ºè®®**: æ‰€æœ‰æ¢ç´¢å‡½æ•°éƒ½åº”è¯¥ä½¿ç”¨ç¼“å­˜ã€‚

---

### ç¼ºé™· #3: ç²¾åº¦å¸¸æ•°æœªè¢«ä½¿ç”¨

**é—®é¢˜**: å®šä¹‰äº†ç²¾åº¦å¸¸æ•°ä½†æœªä½¿ç”¨

```rust
pub const CRF_PRECISION: f32 = 0.1;
pub const COARSE_STEP: f32 = 2.0;
pub const FINE_STEP: f32 = 0.5;
pub const ULTRA_FINE_STEP: f32 = 0.1;
```

ä½†å®é™…ä»£ç ä¸­ç¡¬ç¼–ç äº†æ­¥é•¿å€¼ã€‚

---

### ç¼ºé™· #4: é»„é‡‘åˆ†å‰²æœç´¢å®ç°æœ‰è¯¯

**ä½ç½®**: `explore_precise_quality_match` çº¦ 870-900 è¡Œ

**é—®é¢˜ä»£ç **:
```rust
const PHI: f32 = 0.618;
let mid = low + (high - low) * PHI;
```

**åˆ†æ**:
- é»„é‡‘åˆ†å‰²æœç´¢éœ€è¦**ä¸¤ä¸ª**æ¢æµ‹ç‚¹ï¼Œä¸æ˜¯ä¸€ä¸ª
- æ­£ç¡®çš„é»„é‡‘åˆ†å‰²æœç´¢åº”è¯¥æ˜¯ï¼š
  ```rust
  let x1 = high - (high - low) * PHI;
  let x2 = low + (high - low) * PHI;
  ```
- å½“å‰å®ç°å®é™…ä¸Šæ˜¯**åå‘ä¸€ä¾§çš„äºŒåˆ†æœç´¢**ï¼Œä¸æ˜¯çœŸæ­£çš„é»„é‡‘åˆ†å‰²

---

### ç¼ºé™· #5: SSIM æ¯”è¾ƒç²¾åº¦é—®é¢˜

**é—®é¢˜ä»£ç **:
```rust
if ssim > best_ssim + 0.00001 || (ssim >= best_ssim - 0.00001 && mid_rounded > best_crf) {
```

**åˆ†æ**:
- ä½¿ç”¨äº†ç¡¬ç¼–ç çš„ `0.00001`
- åº”è¯¥ä½¿ç”¨ `precision::SSIM_COMPARE_EPSILON`

---

## ğŸŸ¢ ä¿®å¤å»ºè®®

### ä¿®å¤ #1: `explore_size_only` äºŒåˆ†æœç´¢æ–¹å‘

```rust
// ä¿®å¤å‰
if size < self.input_size {
    best_crf = mid as f32;
    best_size = size;
    low = mid;  // âŒ é”™è¯¯
} else {
    high = mid; // âŒ é”™è¯¯
}

// ä¿®å¤å
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œè®°å½•å¹¶å°è¯•æ›´ä½ CRFï¼ˆçœ‹èƒ½å¦ä¿æŒå‹ç¼©åŒæ—¶æé«˜è´¨é‡ï¼‰
    best_crf = mid as f32;
    best_size = size;
    high = mid;  // âœ… å¾€æ›´ä½ CRF æœç´¢
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´é«˜ CRF
    low = mid;   // âœ… å¾€æ›´é«˜ CRF æœç´¢
}
```

**ç­‰ç­‰ï¼é‡æ–°åˆ†æç›®æ ‡**ï¼š

`explore_size_only` çš„ç›®æ ‡æ˜¯æ‰¾**æœ€å°æ–‡ä»¶**ï¼ˆæœ€é«˜èƒ½å‹ç¼©çš„ CRFï¼‰

æ‰€ä»¥ï¼š
- å½“èƒ½å‹ç¼©æ—¶ï¼Œåº”è¯¥å°è¯•**æ›´é«˜** CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
- å½“ä¸èƒ½å‹ç¼©æ—¶ï¼Œåº”è¯¥å°è¯•**æ›´ä½** CRFï¼ˆæ›´å¤§æ–‡ä»¶ï¼Œä½†å¯èƒ½èƒ½å‹ç¼©ï¼‰

**å†æ¬¡ä¿®æ­£**:
```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œå°è¯•æ›´é«˜ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
    best_crf = mid as f32;
    best_size = size;
    low = mid;   // âœ… å¾€æ›´é«˜ CRF æœç´¢ï¼ˆæ›´å°æ–‡ä»¶ï¼‰
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´ä½ CRFï¼ˆæ›´å¤§æ–‡ä»¶ï¼Œä½†å¯èƒ½èƒ½å‹ç¼©ï¼‰
    high = mid;  // âœ… å¾€æ›´ä½ CRF æœç´¢
}
```

**ç»“è®º**: åŸä»£ç æ˜¯æ­£ç¡®çš„ï¼æˆ‘ä¹‹å‰çš„åˆ†ææœ‰è¯¯ã€‚

è®©æˆ‘é‡æ–°åˆ†æ...

---

## ğŸ”„ é‡æ–°åˆ†æ

### äºŒåˆ†æœç´¢ç›®æ ‡æ¾„æ¸…

| ç›®æ ‡ | å½“èƒ½å‹ç¼©æ—¶ | å½“ä¸èƒ½å‹ç¼©æ—¶ |
|------|------------|--------------|
| æ‰¾æœ€å°æ–‡ä»¶ï¼ˆæœ€é«˜ CRFï¼‰ | `low = mid`ï¼ˆå¾€é«˜ CRFï¼‰ | `high = mid`ï¼ˆå¾€ä½ CRFï¼‰ |
| æ‰¾æœ€é«˜è´¨é‡ï¼ˆæœ€ä½ CRFï¼‰ | `high = mid`ï¼ˆå¾€ä½ CRFï¼‰ | `low = mid`ï¼ˆå¾€é«˜ CRFï¼‰ |

### `explore_size_only` ç›®æ ‡ï¼šæ‰¾æœ€å°æ–‡ä»¶

```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œå°è¯•æ›´é«˜ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
    low = mid;   // âœ… æ­£ç¡®
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´ä½ CRF
    high = mid;  // âœ… æ­£ç¡®
}
```

**ç»“è®º**: åŸä»£ç é€»è¾‘æ­£ç¡®ï¼

### `explore_compress_only` ç›®æ ‡ï¼šæ‰¾æœ€é«˜è´¨é‡ï¼ˆæœ€ä½èƒ½å‹ç¼©çš„ CRFï¼‰

```rust
if size < self.input_size {
    // èƒ½å‹ç¼©ï¼Œå°è¯•æ›´ä½ CRFï¼ˆæ›´é«˜è´¨é‡ï¼‰
    high = mid;  // âœ… æ­£ç¡®
} else {
    // ä¸èƒ½å‹ç¼©ï¼Œéœ€è¦æ›´é«˜ CRF
    low = mid;   // âœ… æ­£ç¡®
}
```

**ç»“è®º**: åŸä»£ç é€»è¾‘æ­£ç¡®ï¼

---

## ğŸ¯ æœ€ç»ˆç»“è®º

ç»è¿‡æ·±å…¥åˆ†æï¼Œ**åŸä»£ç çš„äºŒåˆ†æœç´¢é€»è¾‘æ˜¯æ­£ç¡®çš„**ï¼

ç”¨æˆ·æŠ¥å‘Šçš„ Bug å¯èƒ½æ˜¯å¯¹ç›®æ ‡çš„è¯¯è§£ï¼š
- `explore_size_only`ï¼šæ‰¾**æœ€é«˜**èƒ½å‹ç¼©çš„ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰
- `explore_compress_only`ï¼šæ‰¾**æœ€ä½**èƒ½å‹ç¼©çš„ CRFï¼ˆæœ€é«˜è´¨é‡ï¼‰

ä¸¤è€…çš„æœç´¢æ–¹å‘æ˜¯**ç›¸åçš„**ï¼Œè¿™æ˜¯æ­£ç¡®çš„è®¾è®¡ã€‚

---

## ğŸ“‹ çœŸæ­£éœ€è¦ä¿®å¤çš„é—®é¢˜

1. **ç»Ÿä¸€ç²¾åº¦å¸¸æ•°ä½¿ç”¨**ï¼šç”¨ `precision::*` æ›¿ä»£ç¡¬ç¼–ç å€¼
2. **ç»Ÿä¸€ç¼“å­˜æœºåˆ¶**ï¼šæ‰€æœ‰æ¢ç´¢å‡½æ•°éƒ½åº”è¯¥ä½¿ç”¨ç¼“å­˜
3. **ä¿®å¤é»„é‡‘åˆ†å‰²æœç´¢**ï¼šå®ç°çœŸæ­£çš„é»„é‡‘åˆ†å‰²æˆ–æ”¹ç”¨å…¶ä»–ç®—æ³•
4. **æ”¹è¿›æ³¨é‡Š**ï¼šæ˜ç¡®æ¯ä¸ªå‡½æ•°çš„ç›®æ ‡å’Œæœç´¢æ–¹å‘
5. **æ·»åŠ å•å…ƒæµ‹è¯•**ï¼šéªŒè¯äºŒåˆ†æœç´¢çš„æ­£ç¡®æ€§

---

## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] ç»Ÿä¸€ä½¿ç”¨ç²¾åº¦å¸¸æ•°
- [ ] ä¸ºæ‰€æœ‰æ¢ç´¢å‡½æ•°æ·»åŠ ç¼“å­˜
- [ ] ä¿®å¤æˆ–ç§»é™¤é»„é‡‘åˆ†å‰²æœç´¢
- [ ] æ”¹è¿›å‡½æ•°æ³¨é‡Š
- [ ] æ·»åŠ äºŒåˆ†æœç´¢å•å…ƒæµ‹è¯•
