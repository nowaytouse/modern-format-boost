# Modern Format Boost v4.7 - Bug æ·±åº¦åˆ†æžï¼ˆæœ€ç»ˆç‰ˆï¼‰

## âœ… å·²ä¿®å¤

### Bug #1: `explore_size_only` äºŒåˆ†æœç´¢é€»è¾‘é—®é¢˜

**é—®é¢˜**ï¼šåŽŸä»£ç ä½¿ç”¨äºŒåˆ†æœç´¢æ‰¾"æœ€é«˜èƒ½åŽ‹ç¼©çš„ CRF"ï¼Œä½†é€»è¾‘æœ‰çŸ›ç›¾ï¼š
- å½“ `mid` ä¸èƒ½åŽ‹ç¼©æ—¶ï¼Œ`high = mid` ä¼šå¾€æ›´ä½Ž CRF æœç´¢
- ä½†æ›´ä½Ž CRF æ„å‘³ç€æ›´å¤§æ–‡ä»¶ï¼Œæ›´ä¸å¯èƒ½åŽ‹ç¼©

**ä¿®å¤**ï¼šç®€åŒ–é€»è¾‘
- æ—¢ç„¶ `max_crf` èƒ½åŽ‹ç¼©ä¸”äº§ç”Ÿæœ€å°æ–‡ä»¶ï¼Œç›´æŽ¥ç”¨å®ƒ
- ç§»é™¤æœ‰é—®é¢˜çš„äºŒåˆ†æœç´¢
- ä¿ç•™ Phase 3 çš„ç²¾ç»†åŒ–é€»è¾‘

---

## ðŸ”´ æ ¸å¿ƒé—®é¢˜ï¼šäºŒåˆ†æœç´¢ç›®æ ‡ä¸Žå®žçŽ°çš„çŸ›ç›¾

### `explore_size_only` çš„ç›®æ ‡åˆ†æž

**å£°æ˜Žçš„ç›®æ ‡**ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„**æœ€é«˜** CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰

**CRF ä¸Žæ–‡ä»¶å¤§å°çš„å…³ç³»**ï¼š
- CRF è¶Šé«˜ â†’ åŽ‹ç¼©è¶Šæ¿€è¿› â†’ æ–‡ä»¶è¶Šå° â†’ è´¨é‡è¶Šä½Ž
- CRF è¶Šä½Ž â†’ åŽ‹ç¼©è¶Šä¿å®ˆ â†’ æ–‡ä»¶è¶Šå¤§ â†’ è´¨é‡è¶Šé«˜

**æœç´¢ç©ºé—´**ï¼š
```
CRF:    [initial_crf=18] -------- [max_crf=28]
æ–‡ä»¶å¤§å°: [å¤§] ---------------------- [å°]
åŽ‹ç¼©èƒ½åŠ›: [å¯èƒ½ä¸èƒ½åŽ‹ç¼©] ------------ [ä¸€å®šèƒ½åŽ‹ç¼©]
```

### äºŒåˆ†æœç´¢çš„æ­£ç¡®é€»è¾‘

**ç›®æ ‡**ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„**æœ€é«˜** CRF

**å…³é”®æ´žå¯Ÿ**ï¼š
- å¦‚æžœ `max_crf` éƒ½ä¸èƒ½åŽ‹ç¼©ï¼Œé‚£å°±æ²¡æœ‰è§£
- å¦‚æžœ `max_crf` èƒ½åŽ‹ç¼©ï¼Œé‚£è§£ä¸€å®šå­˜åœ¨äºŽ `[initial_crf, max_crf]` ä¹‹é—´
- æˆ‘ä»¬è¦æ‰¾çš„æ˜¯**æœ€é«˜**èƒ½åŽ‹ç¼©çš„ CRF

**æ­£ç¡®çš„äºŒåˆ†æœç´¢**ï¼š

```rust
// ç›®æ ‡ï¼šæ‰¾æœ€é«˜èƒ½åŽ‹ç¼©çš„ CRF
// æœç´¢ç©ºé—´ï¼š[low, high]
// ä¸å˜é‡ï¼šhigh ä¸€å®šèƒ½åŽ‹ç¼©ï¼Œlow å¯èƒ½ä¸èƒ½åŽ‹ç¼©

let mut low = self.config.initial_crf;
let mut high = self.config.max_crf;  // å·²éªŒè¯èƒ½åŽ‹ç¼©

while high - low > 1.0 {
    let mid = (low + high) / 2.0;
    let size = self.encode(mid)?;
    
    if size < self.input_size {
        // mid èƒ½åŽ‹ç¼©ï¼Œmid å¯èƒ½æ˜¯ç­”æ¡ˆï¼Œä½†æ›´é«˜çš„ CRF å¯èƒ½ä¹Ÿèƒ½åŽ‹ç¼©
        // æ‰€ä»¥ç»§ç»­åœ¨ [mid, high] æœç´¢
        low = mid;  // âœ… æ­£ç¡®
    } else {
        // mid ä¸èƒ½åŽ‹ç¼©ï¼Œç­”æ¡ˆä¸€å®šåœ¨ [low, mid) ä¹‹é—´
        // ä½†æˆ‘ä»¬è¦æ‰¾æœ€é«˜çš„ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ [mid, high] æœç´¢
        // ç­‰ç­‰ï¼Œmid ä¸èƒ½åŽ‹ç¼©ï¼Œé‚£ [mid, high] ä¸­åªæœ‰ high èƒ½åŽ‹ç¼©
        // æ‰€ä»¥åº”è¯¥åœ¨ [low, mid] æœç´¢ï¼Ÿ
        // ä¸å¯¹ï¼å¦‚æžœ mid ä¸èƒ½åŽ‹ç¼©ï¼Œé‚£æ¯” mid æ›´ä½Žçš„ CRF æ›´ä¸å¯èƒ½åŽ‹ç¼©
        // æ‰€ä»¥åº”è¯¥åœ¨ [mid, high] æœç´¢
        low = mid;  // âœ… æ­£ç¡®
    }
}
```

**ç­‰ç­‰ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½æ˜¯ `low = mid`ï¼Ÿ**

è¿™è¯´æ˜Žæˆ‘çš„åˆ†æžæœ‰é—®é¢˜ã€‚è®©æˆ‘é‡æ–°æ€è€ƒ...

---

## ðŸ”„ é‡æ–°åˆ†æž

### é—®é¢˜çš„æœ¬è´¨

**ç›®æ ‡**ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„**æœ€é«˜** CRF

**æœç´¢ç©ºé—´çš„å•è°ƒæ€§**ï¼š
- CRF è¶Šé«˜ â†’ æ–‡ä»¶è¶Šå° â†’ è¶Šå®¹æ˜“åŽ‹ç¼©
- æ‰€ä»¥å­˜åœ¨ä¸€ä¸ª**ä¸´ç•Œç‚¹** `threshold_crf`ï¼š
  - CRF >= threshold_crf â†’ èƒ½åŽ‹ç¼©
  - CRF < threshold_crf â†’ ä¸èƒ½åŽ‹ç¼©

**äºŒåˆ†æœç´¢çš„ç›®æ ‡**ï¼šæ‰¾åˆ° `threshold_crf`

### æ­£ç¡®çš„äºŒåˆ†æœç´¢

```rust
// ä¸å˜é‡ï¼š
// - low å¯èƒ½ä¸èƒ½åŽ‹ç¼©
// - high ä¸€å®šèƒ½åŽ‹ç¼©
// ç›®æ ‡ï¼šæ‰¾åˆ°æœ€å°çš„èƒ½åŽ‹ç¼©çš„ CRFï¼ˆå³ threshold_crfï¼‰

let mut low = self.config.initial_crf;
let mut high = self.config.max_crf;  // å·²éªŒè¯èƒ½åŽ‹ç¼©

while high - low > 1.0 {
    let mid = (low + high) / 2.0;
    let size = self.encode(mid)?;
    
    if size < self.input_size {
        // mid èƒ½åŽ‹ç¼©ï¼Œthreshold å¯èƒ½æ›´ä½Ž
        high = mid;  // æ”¶ç¼©ä¸Šç•Œ
    } else {
        // mid ä¸èƒ½åŽ‹ç¼©ï¼Œthreshold ä¸€å®šæ›´é«˜
        low = mid;   // æ”¶ç¼©ä¸‹ç•Œ
    }
}

// ç»“æŸæ—¶ï¼Œhigh æ˜¯æœ€å°çš„èƒ½åŽ‹ç¼©çš„ CRF
// ä½†æˆ‘ä»¬è¦çš„æ˜¯æœ€é«˜çš„èƒ½åŽ‹ç¼©çš„ CRF...
```

**é—®é¢˜å‘çŽ°**ï¼š
- ä¸Šé¢çš„æœç´¢æ‰¾çš„æ˜¯**æœ€å°**èƒ½åŽ‹ç¼©çš„ CRF
- ä½† `explore_size_only` çš„ç›®æ ‡æ˜¯æ‰¾**æœ€é«˜**èƒ½åŽ‹ç¼©çš„ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰

**çŸ›ç›¾**ï¼š
- å¦‚æžœ CRF è¶Šé«˜æ–‡ä»¶è¶Šå°ï¼Œé‚£**æœ€é«˜**èƒ½åŽ‹ç¼©çš„ CRF å°±æ˜¯ `max_crf`ï¼ˆåªè¦å®ƒèƒ½åŽ‹ç¼©ï¼‰
- æ‰€ä»¥æ ¹æœ¬ä¸éœ€è¦äºŒåˆ†æœç´¢ï¼

---

## ðŸŽ¯ çœŸæ­£çš„é—®é¢˜

### `explore_size_only` çš„ç›®æ ‡å®šä¹‰æœ‰é—®é¢˜

**å½“å‰ç›®æ ‡**ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„æœ€é«˜ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰

**é—®é¢˜**ï¼šå¦‚æžœ `max_crf` èƒ½åŽ‹ç¼©ï¼Œé‚£å®ƒå°±æ˜¯ç­”æ¡ˆï¼Œä¸éœ€è¦æœç´¢

**å®žé™…åº”è¯¥çš„ç›®æ ‡**ï¼š
- é€‰é¡¹ Aï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„**æœ€ä½Ž** CRFï¼ˆæœ€é«˜è´¨é‡ï¼‰â†’ è¿™æ˜¯ `explore_compress_only` çš„ç›®æ ‡
- é€‰é¡¹ Bï¼šæ‰¾åˆ°**æœ€å°æ–‡ä»¶**çš„ CRF â†’ è¿™å°±æ˜¯ `max_crf`ï¼ˆå¦‚æžœèƒ½åŽ‹ç¼©ï¼‰

### ä»£ç çš„å®žé™…è¡Œä¸º

è®©æˆ‘è¿½è¸ªä»£ç çš„å®žé™…è¡Œä¸ºï¼š

```rust
// åˆå§‹çŠ¶æ€
low = initial_crf = 18
high = max_crf = 28
best_crf = max_crf = 28  // å·²éªŒè¯èƒ½åŽ‹ç¼©

// ç¬¬ä¸€æ¬¡è¿­ä»£
mid = (18 + 28) / 2 = 23
if size(23) < input_size:
    best_crf = 23
    low = 23  // æœç´¢èŒƒå›´å˜æˆ [23, 28]
else:
    high = 23  // æœç´¢èŒƒå›´å˜æˆ [18, 23]

// å¦‚æžœ CRF=23 èƒ½åŽ‹ç¼©ï¼Œç»§ç»­åœ¨ [23, 28] æœç´¢
// å¦‚æžœ CRF=23 ä¸èƒ½åŽ‹ç¼©ï¼Œç»§ç»­åœ¨ [18, 23] æœç´¢
```

**åˆ†æž**ï¼š
- å½“ CRF=23 èƒ½åŽ‹ç¼©æ—¶ï¼Œ`low = 23`ï¼Œæœç´¢ [23, 28]
  - è¿™æ˜¯åœ¨æ‰¾æ›´é«˜çš„ CRFï¼Œç¬¦åˆ"æ‰¾æœ€é«˜èƒ½åŽ‹ç¼©çš„ CRF"çš„ç›®æ ‡
- å½“ CRF=23 ä¸èƒ½åŽ‹ç¼©æ—¶ï¼Œ`high = 23`ï¼Œæœç´¢ [18, 23]
  - è¿™æ˜¯åœ¨æ‰¾æ›´ä½Žçš„ CRFï¼Œä½†æ›´ä½Žçš„ CRF æ›´ä¸å¯èƒ½åŽ‹ç¼©ï¼
  - **è¿™æ˜¯ Bugï¼**

---

## ðŸ”´ ç¡®è®¤ Bug

### Bug æè¿°

åœ¨ `explore_size_only` ä¸­ï¼Œå½“ `mid` ä¸èƒ½åŽ‹ç¼©æ—¶ï¼Œä»£ç æ‰§è¡Œ `high = mid`ï¼Œè¿™ä¼šè®©æœç´¢å¾€æ›´ä½Ž CRF æ–¹å‘è¿›è¡Œã€‚ä½†æ›´ä½Žçš„ CRF æ„å‘³ç€æ›´å¤§çš„æ–‡ä»¶ï¼Œæ›´ä¸å¯èƒ½åŽ‹ç¼©ã€‚

### æ­£ç¡®çš„é€»è¾‘

å½“ `mid` ä¸èƒ½åŽ‹ç¼©æ—¶ï¼Œåº”è¯¥æ”¾å¼ƒ `mid` åŠä»¥ä¸‹çš„æ‰€æœ‰ CRFï¼Œåªåœ¨ `[mid, high]` ä¸­æœç´¢ã€‚

ä½†è¿™æ ·çš„è¯ï¼Œå¦‚æžœ `mid` ä¸èƒ½åŽ‹ç¼©ï¼Œè€Œ `high` èƒ½åŽ‹ç¼©ï¼Œé‚£ç­”æ¡ˆå°±æ˜¯ `high`ï¼ˆæˆ–è€… `high` é™„è¿‘çš„æŸä¸ªå€¼ï¼‰ã€‚

### ä¿®å¤æ–¹æ¡ˆ

```rust
if size < self.input_size {
    // èƒ½åŽ‹ç¼©ï¼Œè®°å½•å¹¶å°è¯•æ›´é«˜ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰
    best_crf = mid as f32;
    best_size = size;
    low = mid;   // ç»§ç»­åœ¨ [mid, high] æœç´¢
} else {
    // ä¸èƒ½åŽ‹ç¼©ï¼Œmid åŠä»¥ä¸‹éƒ½ä¸è¡Œï¼Œåªèƒ½åœ¨ (mid, high] æœç´¢
    // ä½†äºŒåˆ†æœç´¢éœ€è¦ low < highï¼Œæ‰€ä»¥ï¼š
    low = mid;   // âœ… ä¿®å¤ï¼šä¹Ÿæ˜¯ low = mid
}
```

**ç­‰ç­‰ï¼Œè¿™æ ·ä¸¤ä¸ªåˆ†æ”¯éƒ½æ˜¯ `low = mid`ï¼Ÿ**

æ˜¯çš„ï¼å› ä¸ºï¼š
- å½“èƒ½åŽ‹ç¼©æ—¶ï¼Œæˆ‘ä»¬æƒ³æ‰¾æ›´é«˜çš„ CRFï¼ˆæ›´å°æ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥ `low = mid`
- å½“ä¸èƒ½åŽ‹ç¼©æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ mid åŠä»¥ä¸‹éƒ½ä¸è¡Œï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ `low = mid`

**ä½†è¿™æ ·æœç´¢å°±æ²¡æœ‰æ„ä¹‰äº†**ï¼Œå› ä¸ºæ¯æ¬¡éƒ½æ˜¯ `low = mid`ï¼Œ`high` æ°¸è¿œä¸å˜ã€‚

---

## ðŸ”„ æœ€ç»ˆåˆ†æž

### é—®é¢˜çš„æ ¹æº

`explore_size_only` çš„ç›®æ ‡å®šä¹‰æœ‰é—®é¢˜ï¼š

**å£°æ˜Žçš„ç›®æ ‡**ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„æœ€é«˜ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰

**å®žé™…ä¸Š**ï¼š
- å¦‚æžœ `max_crf` èƒ½åŽ‹ç¼©ï¼Œé‚£å®ƒå°±æ˜¯ç­”æ¡ˆ
- å¦‚æžœ `max_crf` ä¸èƒ½åŽ‹ç¼©ï¼Œé‚£æ²¡æœ‰è§£

**æ‰€ä»¥æ ¹æœ¬ä¸éœ€è¦äºŒåˆ†æœç´¢ï¼**

### ä»£ç çš„å®žé™…æ„å›¾

çœ‹ä»£ç çš„ Phase 3ï¼ˆè¾¹ç•Œç²¾ç»†åŒ–ï¼‰ï¼Œå®ƒåœ¨ `best_crf` é™„è¿‘ç”¨ 0.5 æ­¥é•¿å¾®è°ƒï¼Œå°è¯•æ‰¾æ›´é«˜çš„ CRFã€‚

è¿™è¯´æ˜Žä»£ç çš„å®žé™…æ„å›¾æ˜¯ï¼š
1. æ‰¾åˆ°ä¸€ä¸ªèƒ½åŽ‹ç¼©çš„ CRF
2. ç„¶åŽå°è¯•æ›´é«˜çš„ CRFï¼Œçœ‹èƒ½å¦å¾—åˆ°æ›´å°çš„æ–‡ä»¶

### æ­£ç¡®çš„å®žçŽ°

```rust
// ç›®æ ‡ï¼šæ‰¾åˆ°èƒ½åŽ‹ç¼©çš„æœ€é«˜ CRFï¼ˆæœ€å°æ–‡ä»¶ï¼‰

// Phase 1: éªŒè¯ max_crf èƒ½å¦åŽ‹ç¼©
let max_size = self.encode(self.config.max_crf)?;
if max_size >= self.input_size {
    // å³ä½¿æœ€é«˜ CRF ä¹Ÿæ— æ³•åŽ‹ç¼©ï¼Œæ— è§£
    return Err("Cannot compress");
}

// Phase 2: max_crf èƒ½åŽ‹ç¼©ï¼Œå®ƒå°±æ˜¯ç­”æ¡ˆ
// ä½†ä¸ºäº†æ‰¾åˆ°"åˆšå¥½èƒ½åŽ‹ç¼©"çš„è¾¹ç•Œï¼Œæˆ‘ä»¬äºŒåˆ†æœç´¢

// ç›®æ ‡ï¼šæ‰¾åˆ°æœ€ä½Žçš„èƒ½åŽ‹ç¼©çš„ CRFï¼ˆè¾¹ç•Œï¼‰
let mut low = self.config.initial_crf;
let mut high = self.config.max_crf;

while high - low > 1.0 {
    let mid = (low + high) / 2.0;
    let size = self.encode(mid)?;
    
    if size < self.input_size {
        // mid èƒ½åŽ‹ç¼©ï¼Œè¾¹ç•Œå¯èƒ½æ›´ä½Ž
        high = mid;
    } else {
        // mid ä¸èƒ½åŽ‹ç¼©ï¼Œè¾¹ç•Œä¸€å®šæ›´é«˜
        low = mid;
    }
}

// high æ˜¯æœ€ä½Žçš„èƒ½åŽ‹ç¼©çš„ CRF
// ä½†æˆ‘ä»¬è¦çš„æ˜¯æœ€é«˜çš„èƒ½åŽ‹ç¼©çš„ CRFï¼Œé‚£å°±æ˜¯ max_crfï¼

// æ‰€ä»¥è¿™ä¸ªäºŒåˆ†æœç´¢çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ
// ç­”ï¼šæ‰¾åˆ°åŽ‹ç¼©è¾¹ç•Œï¼Œç„¶åŽåœ¨è¾¹ç•Œé™„è¿‘ç²¾ç»†åŒ–
```

---

## ðŸŽ¯ æœ€ç»ˆç»“è®º

### Bug ç¡®è®¤

`explore_size_only` çš„äºŒåˆ†æœç´¢é€»è¾‘**æœ‰ Bug**ï¼š

```rust
// å½“å‰ä»£ç ï¼ˆæœ‰ Bugï¼‰
if size < self.input_size {
    low = mid;   // å¾€æ›´é«˜ CRF æœç´¢
} else {
    high = mid;  // âŒ Bugï¼šå¾€æ›´ä½Ž CRF æœç´¢ï¼Œä½†æ›´ä½Ž CRF æ›´ä¸å¯èƒ½åŽ‹ç¼©
}
```

### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ A**ï¼šä¿®å¤äºŒåˆ†æœç´¢æ–¹å‘

```rust
if size < self.input_size {
    // èƒ½åŽ‹ç¼©ï¼Œè¾¹ç•Œå¯èƒ½æ›´ä½Ž
    best_crf = mid as f32;
    best_size = size;
    high = mid;  // å¾€æ›´ä½Ž CRF æœç´¢ï¼ˆæ‰¾è¾¹ç•Œï¼‰
} else {
    // ä¸èƒ½åŽ‹ç¼©ï¼Œè¾¹ç•Œä¸€å®šæ›´é«˜
    low = mid;   // å¾€æ›´é«˜ CRF æœç´¢
}
// æœ€åŽ high æ˜¯æœ€ä½Žèƒ½åŽ‹ç¼©çš„ CRF
// ä½†æˆ‘ä»¬è¦æœ€å°æ–‡ä»¶ï¼Œæ‰€ä»¥ç”¨ max_crf
```

**æ–¹æ¡ˆ B**ï¼šç®€åŒ–é€»è¾‘

æ—¢ç„¶ç›®æ ‡æ˜¯æ‰¾æœ€å°æ–‡ä»¶ï¼Œè€Œ `max_crf` äº§ç”Ÿæœ€å°æ–‡ä»¶ï¼Œé‚£ç›´æŽ¥ç”¨ `max_crf` å°±è¡Œï¼š

```rust
// ç®€åŒ–ç‰ˆ
let max_size = self.encode(self.config.max_crf)?;
if max_size < self.input_size {
    return Ok(ExploreResult { crf: max_crf, size: max_size, ... });
} else {
    return Err("Cannot compress");
}
```

### æŽ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ B**ï¼ˆç®€åŒ–é€»è¾‘ï¼‰æ›´åˆç†ï¼Œå› ä¸ºï¼š
1. ç›®æ ‡æ˜Žç¡®ï¼šæ‰¾æœ€å°æ–‡ä»¶
2. é€»è¾‘ç®€å•ï¼šç›´æŽ¥ç”¨ max_crf
3. æ•ˆçŽ‡é«˜ï¼šåªéœ€ä¸€æ¬¡ç¼–ç 

å¦‚æžœéœ€è¦æ‰¾"åˆšå¥½èƒ½åŽ‹ç¼©"çš„è¾¹ç•Œï¼ˆä¸ºäº†ä¿ç•™æ›´é«˜è´¨é‡ï¼‰ï¼Œé‚£åº”è¯¥ç”¨ `explore_compress_only`ã€‚
