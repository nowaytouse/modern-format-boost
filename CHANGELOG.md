# Changelog

All notable changes to this project will be documented in this file.

## [8.2.2] - 2026-02-20

### ðŸ”¥ Critical Bug Fixes

#### WebP/GIF Animation Duration Detection
- **Fixed ffprobe N/A Issue**: ffprobe returns `N/A` for WebP/GIF animation duration metadata
- **Added ImageMagick Identify Fallback**: New detection method using `identify -format "%T"` to read frame delays in centiseconds
- **Accurate Duration Calculation**: Sums all frame delays to calculate total animation duration
- **Impact**: 35+ animated WebP files that were previously skipped will now be correctly converted:
  - Duration â‰¥3s â†’ HEVC MP4
  - Duration <3s â†’ GIF (Bayer 256 colors)

#### Extension Mismatch Handling
- **Content-Aware Extension Correction**: Files are now renamed to match their actual content format before processing
  - `.jpeg` containing HEIC â†’ renamed to `.heic`
  - `.jpeg` containing WebP â†’ renamed to `.webp`
  - `.jpeg` containing PNG â†’ renamed to `.png`
  - `.jpeg` containing TIFF â†’ renamed to `.tiff`
- **Prevents Wrong Re-encoding**: Fixed issue where HEIC/WebP files with `.jpeg` extension were incorrectly re-encoded as JPEG by ImageMagick structural repair

#### On-Demand Structural Repair
- **Changed from Unconditional to On-Demand**: ImageMagick structural repair now only runs when exiftool detects metadata corruption
- **Performance Improvement**: Saves 100-300ms per file for healthy files (no unnecessary re-encoding)
- **Quality Protection**: Avoids unnecessary re-encoding for files without metadata issues

### ðŸŒ Internationalization

#### Complete English Output
- **All User-Facing Messages**: Converted from Simplified Chinese to English
- **Error Messages**: Full English translations for all error outputs
- **Console Output**: All processing logs, warnings, and success messages now in English
- **Comments**: Code comments translated to English for better maintainability

### ðŸ“¦ Dependencies Updated
- `console`: 0.15 â†’ 0.16
- `tempfile`: 3.10 â†’ 3.20
- `proptest`: 1.4 â†’ 1.7

### ðŸ› ï¸ Technical Improvements
- **Magic Bytes Detection**: Extended to support HEIC brands (heic, heix, heim, heis, mif1, msf1)
- **Smart File Copier**: New module for content-aware extension correction
- **Improved Error Handling**: Better fallback mechanisms for format detection failures

## [8.2.1] - 2026-02-20

### ðŸ”§ UI Text Fixes
- **Menu Option Renamed**: "Brotli EXIF Fix Only" â†’ "Fix iCloud Import Errors"
- **Clearer Description**: "Fix corrupted Brotli EXIF metadata that prevents iCloud Photos import"

## [8.2.0] - 2026-02-20

### ðŸŽ Apple Ecosystem Compatibility (Critical Fixes)
- **"Unknown Error" Resolved**: Fixed a critical issue where Apple Photos refused to import files due to extension mismatch (e.g., WebP files renamed as .jpeg).
- **WebP Disguised as JPEG**: Implemented `Magic Bytes` detection. The tool now ignores the literal file extension and inspects the file header. If a `.jpeg` is actually a WebP, it automatically routes it through `dwebp` pre-processing to ensure a valid JXL output.
- **Corrupted JPEG Repair**: Added pre-processing for JPEGs with illegal headers (e.g., missing `FF D8` start bytes). These are now sanitized using ImageMagick before conversion, preventing decoder crashes.
- **Nuclear Metadata Rebuild**: When `Apple Compatibility` mode is enabled, the tool now performs a "Nuclear Rebuild" (`exiftool -all=`) on metadata. This strips out "toxic" non-standard tags injected by third-party editors (e.g., Meitu) that cause Apple Photos to reject valid files.
- **Directory Timestamp Preservation**: Fixed an issue where processing files would update the parent directory's modification time. The tool now recursively saves and restores timestamps for all affected directories (deepest-first).

### âš¡ Core Improvements
- **Smart Format Detection**: Moved away from trusting file extensions. The core logic now relies on binary signatures for `jpg`, `png`, `gif`, `tif`, `webp`, and `mov`.
- **Robust Pre-processing**: Integrated `magick` and `dwebp` deeply into the Rust pipeline to handle edge cases that previously caused `cjxl` to fail.

### ðŸŽ¨ UI/UX
- **Enhanced Logging**: Redesigned the CLI output with hierarchical styling.
  - **Important Alerts**: Now displayed in **Bold/Colored** text.
  - **Technical Details**: Now displayed in **Dimmed (Gray)** text to reduce visual noise.
- **Status Indicators**: Added clearer emojis (`âœ…`, `âš ï¸`, `ðŸ”§`) for operation states.

## [8.1.0] - 2026-02-15
- Initial release of the `modern_format_boost` Rust rewrites.
