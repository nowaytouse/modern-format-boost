# ğŸš€ Modern Format Boost

![Version](https://img.shields.io/badge/version-8.5.0-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Platform](https://img.shields.io/badge/platform-macOS%20%7C%20Linux-lightgrey.svg)

**The Ultimate Media Optimizer & Repair Tool for the Apple Ecosystem.**
**ä¸“ä¸ºè‹¹æœç”Ÿæ€æ‰“é€ çš„ç»ˆæåª’ä½“ä¼˜åŒ–ä¸ä¿®å¤å·¥å…·ã€‚**

---

## ğŸ“– ç®€ä»‹ / Introduction

**Modern Format Boost** is a professional-grade media optimization suite designed to modernize your photo and video library. It losslessly converts legacy formats (JPEG, PNG, GIF, AVC) to modern, high-efficiency standards (JXL, AVIF, HEVC), saving 30-80% storage space without losing a single pixel of quality.

**Modern Format Boost** æ˜¯ä¸€å¥—ä¸“ä¸šçº§çš„åª’ä½“ä¼˜åŒ–å¥—ä»¶ï¼Œæ—¨åœ¨å°†æ‚¨çš„ç…§ç‰‡å’Œè§†é¢‘åº“ç°ä»£åŒ–ã€‚å®ƒèƒ½å°†è¿‡æ—¶çš„æ ¼å¼ï¼ˆJPEG, PNG, GIF, AVCï¼‰æ— æŸè½¬æ¢ä¸ºç°ä»£é«˜æ•ˆæ ‡å‡†ï¼ˆJXL, AVIF, HEVCï¼‰ï¼Œåœ¨ä¸æŸå¤±ä»»ä½•ç”»è´¨çš„å‰æä¸‹èŠ‚çœ 30-80% çš„å­˜å‚¨ç©ºé—´ã€‚

Unlike simple converters, it features a robust **"Self-Healing" engine** specifically engineered to fix files that Apple Photos refuses to import ("Unknown Error"). It handles corrupted headers, mismatched extensions, and toxic metadata automatically.

ä¸ç®€å•çš„è½¬æ¢å™¨ä¸åŒï¼Œå®ƒå†…ç½®äº†å¼ºå¤§çš„**â€œè‡ªæ„ˆâ€å¼•æ“**ï¼Œä¸“é—¨ç”¨äºä¿®å¤ Apple ç…§ç‰‡æ— æ³•å¯¼å…¥ï¼ˆæŠ¥â€œæœªçŸ¥é”™è¯¯â€ï¼‰çš„æ–‡ä»¶ã€‚å®ƒèƒ½è‡ªåŠ¨å¤„ç†æŸåçš„æ–‡ä»¶å¤´ã€æ‰©å±•åä¸åŒ¹é…ä»¥åŠæœ‰æ¯’çš„å…ƒæ•°æ®ã€‚

---

## ğŸ—ï¸ æ™ºèƒ½å¤„ç†ç­–ç•¥ / Smart Processing Strategy

ç¨‹åºåŸºäº **â€œä¿¡æ¯æ— æŸä¼˜å…ˆâ€** å’Œ **â€œé¿å…äºŒä»£æŸè€—â€** åŸåˆ™ï¼Œæ ¹æ®æ–‡ä»¶çŠ¶æ€è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„ï¼š

| åŸå§‹çŠ¶æ€ / Original State | è´¨é‡ç±»å‹ / Type | ç›®æ ‡æ ¼å¼ / Target | æ ¸å¿ƒé€»è¾‘ / Core Logic |
| :--- | :--- | :--- | :--- |
| **PNG / TIFF / BMP** | æ— æŸ / Lossless | **JXL** | 100% æ•°å­¦æ— æŸå‹ç¼© (Saving 20-40%) |
| **JPEG** | æœ‰æŸ / Lossy | **JXL** | **DCT ç³»æ•°ä¿ç•™è½¬ç ** (Zero quality loss!) |
| **WebP / AVIF** | æ— æŸ / Lossless | **JXL** | è·¨æ ¼å¼æ— æŸè¿ç§»ï¼Œæ›´ä½³çš„å½’æ¡£æ•ˆç‡ |
| **WebP / AVIF / HEIC** | æœ‰æŸ / Lossy | **è·³è¿‡ / SKIP** | **é˜²æ­¢äºŒä»£æŸè€—** (Avoid generation loss) |
| **GIF / åŠ¨æ€å›¾ç‰‡** | ä»»æ„ (æ—¶é•¿>=3s) | **MP4** | **æ™ºèƒ½ SSIM è£åˆ¤** å¯»æ‰¾è§†è§‰æ— æŸå¹³è¡¡ç‚¹ |
| **æŸå/æœ‰æ¯’å…ƒæ•°æ®** | ä»»æ„çŠ¶æ€ | **Repair** | **å…ƒæ•°æ®å…¨é‡é‡æ„** + ç»“æ„ä¿®å¤ (Fix for Apple) |

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§ / Key Features

### ğŸ Apple Ecosystem Perfected / å®Œç¾é€‚é…è‹¹æœç”Ÿæ€
*   **"Unknown Error" Killer**: Automatically detects and fixes files that crash Apple Photos (e.g., WebP files renamed as .jpeg).
    *   **â€œæœªçŸ¥é”™è¯¯â€ç»ˆç»“è€…**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤å¯¼è‡´è‹¹æœç›¸å†Œå´©æºƒçš„æ–‡ä»¶ï¼ˆä¾‹å¦‚è¢«é‡å‘½åä¸º .jpeg çš„ WebP æ–‡ä»¶ï¼‰ã€‚
*   **Nuclear Metadata Rebuild**: Strips "toxic" non-standard EXIF tags left by third-party editors (Meitu, etc.) while preserving all valid data (GPS, Date, Captions).
    *   **å…ƒæ•°æ®æ ¸å¼¹çº§é‡æ„**ï¼šå‰”é™¤ç¬¬ä¸‰æ–¹ç¼–è¾‘å™¨ï¼ˆå¦‚ç¾å›¾ç§€ç§€ï¼‰ç•™ä¸‹çš„éæ ‡å‡†â€œæœ‰æ¯’â€æ ‡ç­¾ï¼ŒåŒæ—¶å®Œç¾ä¿ç•™æ‰€æœ‰æœ‰æ•ˆæ•°æ®ï¼ˆGPSã€æ—¥æœŸã€è¯´æ˜ï¼‰ã€‚
*   **Directory Timestamp Guard**: Preserves creation/modification dates for **folders** as well as files, keeping your timeline intact.
    *   **æ–‡ä»¶å¤¹æ—¶é—´å®ˆæŠ¤**ï¼šä¸ä»…ä¿ç•™æ–‡ä»¶çš„æ—¶é—´ï¼Œè¿˜å®Œç¾è¿˜åŸ**æ–‡ä»¶å¤¹**çš„åˆ›å»º/ä¿®æ”¹æ—¥æœŸï¼Œç¡®ä¿ç›¸å†Œæ—¶é—´çº¿ä¸ä¹±ã€‚

### âš¡ Smart Conversion / æ™ºèƒ½è½¬æ¢
*   **Lossless JXL**: Converts JPEG/PNG/GIF to JPEG XL (JXL) with mathematically lossless recompression.
    *   **æ— æŸ JXL**ï¼šå°† JPEG/PNG/GIF è½¬æ¢ä¸º JPEG XL (JXL)ï¼Œå®ç°æ•°å­¦ä¸Šçš„æ— æŸå‹ç¼©ã€‚
*   **Smart Fallback**: If `cjxl` fails (due to corruption), the tool automatically switches to `magick` or `ffmpeg` pipelines to sanitize the file and try again.
    *   **æ™ºèƒ½å›é€€**ï¼šå¦‚æœ `cjxl` è½¬æ¢å¤±è´¥ï¼ˆå› æ–‡ä»¶æŸåï¼‰ï¼Œå·¥å…·ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ° `magick` æˆ– `ffmpeg` ç®¡é“æ¸…æ´—æ–‡ä»¶å¹¶é‡è¯•ã€‚
*   **Magic Bytes Detection**: Ignores file extensions. It reads the binary header to determine the *real* format (e.g., detecting a PNG disguised as a JPG).
    *   **é­”æ³•å­—èŠ‚æ£€æµ‹**ï¼šä¸ä¿¡ä»»æ–‡ä»¶æ‰©å±•åã€‚å®ƒè¯»å–äºŒè¿›åˆ¶æ–‡ä»¶å¤´æ¥ç¡®å®š*çœŸå®*æ ¼å¼ï¼ˆä¾‹å¦‚æ£€æµ‹ä¼ªè£…æˆ JPG çš„ PNGï¼‰ã€‚

---

## ğŸ› ï¸ å®‰è£… / Installation

### Prerequisites / å‰ç½®è¦æ±‚
You need `brew` installed on macOS.
æ‚¨éœ€è¦åœ¨ macOS ä¸Šå®‰è£… `brew`ã€‚

```bash
# 1. Install dependencies
brew install jpeg-xl ffmpeg imagemagick exiftool

# 2. Clone the repository
git clone https://github.com/nyamiiko/modern_format_boost.git
cd modern_format_boost

# 3. Build the project
./scripts/smart_build.sh
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³• / Usage

### Drag & Drop (Recommended) / æ‹–æ‹½ä½¿ç”¨ï¼ˆæ¨èï¼‰
Simply drag your folder onto the start script:
åªéœ€å°†æ‚¨çš„æ–‡ä»¶å¤¹æ‹–åˆ°å¯åŠ¨è„šæœ¬ä¸Šï¼š

```bash
./scripts/drag_and_drop_processor.sh /path/to/your/photos
```

### CLI Mode / å‘½ä»¤è¡Œæ¨¡å¼
For advanced users:
é«˜çº§ç”¨æˆ·æ¨¡å¼ï¼š

```bash
# Convert a folder to JXL (Images)
./target/release/img_av1 --input "/path/to/photos" --quality 100 --effort 7

# Convert a folder to HEVC (Videos)
./target/release/vid_hevc --input "/path/to/videos" --crf 18
```

---

## ğŸš‘ æ•…éšœæ’é™¤ / Troubleshooting

### "Unknown Error" in Apple Photos / è‹¹æœç›¸å†Œâ€œæœªçŸ¥é”™è¯¯â€
If you have files that refuse to import, use the dedicated repair tool:
å¦‚æœæ‚¨æœ‰æ— æ³•å¯¼å…¥çš„æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ä¸“ç”¨ä¿®å¤å·¥å…·ï¼š

```bash
./scripts/repair_apple_photos.sh "/path/to/bad/files"
```
**This script will / è¯¥è„šæœ¬å°†ï¼š**
1.  Scan for extension mismatches (Real WebP vs Fake JPEG). / æ‰«ææ‰©å±•åä¸åŒ¹é…ã€‚
2.  Fix corrupted JPEG headers. / ä¿®å¤æŸåçš„ JPEG æ–‡ä»¶å¤´ã€‚
3.  Rebuild metadata from scratch. / é‡æ„å…ƒæ•°æ®ã€‚
4.  Restore original timestamps. / æ¢å¤åŸå§‹æ—¶é—´æˆ³ã€‚

---

## ğŸ”§ Development / å¼€å‘

```bash
cargo build          # Debug æ„å»º
cargo build --release
cargo test           # è¿è¡Œæµ‹è¯•
cargo clippy         # ä»£ç è´¨é‡ä¸æ½œåœ¨é—®é¢˜æ£€æŸ¥
```

Release æ„å»ºå·²å¯ç”¨ LTO ä¸å• codegen-unitï¼Œä»¥æœ€å¤§åŒ–è¿è¡Œæ•ˆç‡ã€‚

---

## ğŸ“‹ æ›´æ–°æ—¥å¿— / Changelog

### v8.5.0 (2026-02-23)
- **æ—¥å¿—ä¸å¹¶å‘**: å¤šæ–‡ä»¶å¹¶è¡Œæ—¶æ¯è¡Œå¸¦ `[æ–‡ä»¶å]` å‰ç¼€ï¼ŒXMP ç”¨ `[XMP]`ï¼›å›ºå®šå®½åº¦ç¼©è¿›å¯¹é½ï¼›UTF-8 å®‰å…¨æˆªæ–­ï¼ˆCJK æ–‡ä»¶åä¸å† panicï¼‰
- **æ—¶é•¿æ£€æµ‹**: ffprobe æ— æ³•ç»™å‡º WebP/GIF æ—¶é•¿æ—¶ï¼Œä½¿ç”¨ ImageMagick `identify` å›é€€ï¼ŒåŠ¨å›¾å¯æ­£å¸¸è½¬ HEVC
- **GIF è´¨é‡**: æ”¯æŒå¯¹ GIF åš SSIM éªŒè¯ï¼ˆæ ¼å¼å½’ä¸€åŒ– + é€æ˜å é»‘åº•ä¸ç¼–ç ä¸€è‡´ï¼‰ï¼›éªŒè¯è·³è¿‡æ—¶æ˜¾ç¤º N/A è€Œé FAILED

### v8.4.0
- **ä»£ç ç°ä»£åŒ–**: ç§»é™¤ `lazy_static` å’Œ `num_cpus` å¤–éƒ¨ä¾èµ–ï¼Œæ”¹ç”¨æ ‡å‡†åº“ `LazyLock` å’Œ `available_parallelism()`
- **å®‰å…¨æ€§ä¿®å¤**: ä¿®å¤ 5 å¤„é™¤é›¶æ¼æ´ï¼ˆPSNR æ’å€¼ã€è´¨é‡è¯„åˆ†ã€ETA è®¡ç®—ç­‰ï¼‰
- **å¥å£®æ€§æå‡**: æ‰€æœ‰ Mutex æ“ä½œæ”¹ç”¨ poison-recovery æ¨¡å¼ï¼Œé˜²æ­¢çº¿ç¨‹ panic å¯¼è‡´æ­»é”
- **ä»£ç å»é‡**: æå– `finalize_conversion()` ç­‰å…±äº«è¾…åŠ©å‡½æ•°ï¼Œæ¶ˆé™¤ä¸¤ä¸ªå›¾åƒè½¬æ¢å™¨ä¸­ ~760 è¡Œé‡å¤ä»£ç 
- **ç‰ˆæœ¬ç»Ÿä¸€**: å…¨éƒ¨ crate ç»Ÿä¸€ä½¿ç”¨ workspace ç‰ˆæœ¬ç»§æ‰¿ (`version.workspace = true`)
- **æ—¥å¿—ä¼˜åŒ–**: stderr è¾“å‡ºå±‚ç§»é™¤å†—ä½™æ—¶é—´æˆ³å’Œçº§åˆ«å‰ç¼€ï¼Œæ›´ç®€æ´

---

## ğŸ“œ License

MIT License. See `LICENSE` for details.
